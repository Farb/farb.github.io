<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="搭建基于主从复制模式的集群 主从复制模式概述 主服务器（Master Server）：负责处理客户端的写请求，写入数据后，会复制到一台或多台Redis服务器。\n从服务器（Slave Server）：负责处理客户端的读请求，从主服务器复制数据。\n主从复制模式的优点：\n写操作集中在主服务器，读操作集中到从服务器，从而实现了读写分离，提升了读写性能。 因为存在数据备份，因此能提升数据的安全性，当主服务器故障时，可以很快切换到从服务器读取数据。 如果项目中并发要求不高，或者哪怕从Redis中读不到数据对性能也不会有太大损害，就可以使用一主一从。\n注意要点：\n一个主服务器可以带一个或多个从服务器，从服务器可以再带从服务器，但在复制时只能把主服务器上的数据复制到从服务器。 一台从服务器只能跟随一台主服务器，不能出现一从多主的模式。 Redis2.8以后的版本，采用异步的复制模式，进行主从复制时不会影响主服务器上的读写操作。 用命令搭建基于主从复制模式的集群 这里搭建一个一主二从模式的集群。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 # 创建主服务器master容器，占用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name master -p 6379:6379 redis ee645f3b1c2a0c56f5eafb5766701e04c638a4b5b26556cf27735ac4f3454618 # 创建从服务器slave1容器，占用6380端口，因为这是模拟一主多从模式，所以宿主机的端口号必须区分开 # 实际项目中，一般多台Redis服务器会部署在不同的服务器上，所以都可以使用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave1 -p 6380:6380 redis 1d054285a7754e35c130b9951d8f3b2e473c8f989a422c993068cff47d1850f6 # 创建从服务器slave2容器，占用6381端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave2 -p 6381:6381 redis c1b27efb7e6c112a83fac13fa1df4f8376faa291885933487d46478f260c568c # 通过docker inspect master可以查看主服务器的详细信息，通过IPAddress可知主服务器容器的IP地址是172.17.0.2 # 真实项目中Redis服务器的IP一般是固定的，而通过Docker容器启动的Redis服务器的IP是动态的，可以通过docker inspect 查看 # 进入master容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it master bash root@ee645f3b1c2a:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出角色是主服务器 role:master # 可看出没有从服务器连接 connected_slaves:0 master_failover_state:no-failover master_replid:821b97303c65400fb0d83fcc05b01545326b6083 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 打开一个新的命令行窗口，进入slave1容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave1 bash root@1d054285a775:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出和主服务器的信息一样，因为还没有设置主从模式，故此时还没区分主从服务器 role:master connected_slaves:0 master_failover_state:no-failover master_replid:59c0aa90a59be9ee610e0ea16f337f69e5116f1a master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 在slave1容器中，通过slaveof命令设置slave1容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 master_link_status:up master_last_io_seconds_ago:8 #... 其他显示省略 # 再次进入master容器中，可以看到master容器中已经有一个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:1 slave0:ip=172.17.0.3,port=6379,state=online,offset=238,lag=1 # 最后进入slave2容器中，通过slaveof命令设置slave2容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave2 bash root@c1b27efb7e6c:/data# redis-cli 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 # 再次进入master容器中，可以看到master容器中已经有两个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:2 slave0:ip=172.17.0.3,port=6379,state=online,offset=630,lag=0 slave1:ip=172.17.0.4,port=6379,state=online,offset=630,lag=0 # 此时，在两个从服务器中执行get name,都返回nil， # 当在主服务器中执行set name farb，两个从服务器中执行get name，都返回farb 通过配置文件搭建主从集群 除了可以使用slaveof命令搭建主从模式的集群，也可以使用redis.conf配置文件来搭建主从模式的集群。\n"><title>基于Docker的Redis实战--搭建Redis集群</title><link rel=canonical href=https://farb.github.io/p/redis_in_action_07_cluster/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="基于Docker的Redis实战--搭建Redis集群"><meta property='og:description' content="搭建基于主从复制模式的集群 主从复制模式概述 主服务器（Master Server）：负责处理客户端的写请求，写入数据后，会复制到一台或多台Redis服务器。\n从服务器（Slave Server）：负责处理客户端的读请求，从主服务器复制数据。\n主从复制模式的优点：\n写操作集中在主服务器，读操作集中到从服务器，从而实现了读写分离，提升了读写性能。 因为存在数据备份，因此能提升数据的安全性，当主服务器故障时，可以很快切换到从服务器读取数据。 如果项目中并发要求不高，或者哪怕从Redis中读不到数据对性能也不会有太大损害，就可以使用一主一从。\n注意要点：\n一个主服务器可以带一个或多个从服务器，从服务器可以再带从服务器，但在复制时只能把主服务器上的数据复制到从服务器。 一台从服务器只能跟随一台主服务器，不能出现一从多主的模式。 Redis2.8以后的版本，采用异步的复制模式，进行主从复制时不会影响主服务器上的读写操作。 用命令搭建基于主从复制模式的集群 这里搭建一个一主二从模式的集群。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 # 创建主服务器master容器，占用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name master -p 6379:6379 redis ee645f3b1c2a0c56f5eafb5766701e04c638a4b5b26556cf27735ac4f3454618 # 创建从服务器slave1容器，占用6380端口，因为这是模拟一主多从模式，所以宿主机的端口号必须区分开 # 实际项目中，一般多台Redis服务器会部署在不同的服务器上，所以都可以使用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave1 -p 6380:6380 redis 1d054285a7754e35c130b9951d8f3b2e473c8f989a422c993068cff47d1850f6 # 创建从服务器slave2容器，占用6381端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave2 -p 6381:6381 redis c1b27efb7e6c112a83fac13fa1df4f8376faa291885933487d46478f260c568c # 通过docker inspect master可以查看主服务器的详细信息，通过IPAddress可知主服务器容器的IP地址是172.17.0.2 # 真实项目中Redis服务器的IP一般是固定的，而通过Docker容器启动的Redis服务器的IP是动态的，可以通过docker inspect 查看 # 进入master容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it master bash root@ee645f3b1c2a:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出角色是主服务器 role:master # 可看出没有从服务器连接 connected_slaves:0 master_failover_state:no-failover master_replid:821b97303c65400fb0d83fcc05b01545326b6083 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 打开一个新的命令行窗口，进入slave1容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave1 bash root@1d054285a775:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出和主服务器的信息一样，因为还没有设置主从模式，故此时还没区分主从服务器 role:master connected_slaves:0 master_failover_state:no-failover master_replid:59c0aa90a59be9ee610e0ea16f337f69e5116f1a master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 在slave1容器中，通过slaveof命令设置slave1容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 master_link_status:up master_last_io_seconds_ago:8 #... 其他显示省略 # 再次进入master容器中，可以看到master容器中已经有一个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:1 slave0:ip=172.17.0.3,port=6379,state=online,offset=238,lag=1 # 最后进入slave2容器中，通过slaveof命令设置slave2容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave2 bash root@c1b27efb7e6c:/data# redis-cli 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 # 再次进入master容器中，可以看到master容器中已经有两个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:2 slave0:ip=172.17.0.3,port=6379,state=online,offset=630,lag=0 slave1:ip=172.17.0.4,port=6379,state=online,offset=630,lag=0 # 此时，在两个从服务器中执行get name,都返回nil， # 当在主服务器中执行set name farb，两个从服务器中执行get name，都返回farb 通过配置文件搭建主从集群 除了可以使用slaveof命令搭建主从模式的集群，也可以使用redis.conf配置文件来搭建主从模式的集群。\n"><meta property='og:url' content='https://farb.github.io/p/redis_in_action_07_cluster/'><meta property='og:site_name' content="Farb's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='redis'><meta property='article:tag' content='docker'><meta property='article:published_time' content='2024-07-31T00:00:00+00:00'><meta property='article:modified_time' content='2024-07-31T00:00:00+00:00'><meta name=twitter:title content="基于Docker的Redis实战--搭建Redis集群"><meta name=twitter:description content="搭建基于主从复制模式的集群 主从复制模式概述 主服务器（Master Server）：负责处理客户端的写请求，写入数据后，会复制到一台或多台Redis服务器。\n从服务器（Slave Server）：负责处理客户端的读请求，从主服务器复制数据。\n主从复制模式的优点：\n写操作集中在主服务器，读操作集中到从服务器，从而实现了读写分离，提升了读写性能。 因为存在数据备份，因此能提升数据的安全性，当主服务器故障时，可以很快切换到从服务器读取数据。 如果项目中并发要求不高，或者哪怕从Redis中读不到数据对性能也不会有太大损害，就可以使用一主一从。\n注意要点：\n一个主服务器可以带一个或多个从服务器，从服务器可以再带从服务器，但在复制时只能把主服务器上的数据复制到从服务器。 一台从服务器只能跟随一台主服务器，不能出现一从多主的模式。 Redis2.8以后的版本，采用异步的复制模式，进行主从复制时不会影响主服务器上的读写操作。 用命令搭建基于主从复制模式的集群 这里搭建一个一主二从模式的集群。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 # 创建主服务器master容器，占用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name master -p 6379:6379 redis ee645f3b1c2a0c56f5eafb5766701e04c638a4b5b26556cf27735ac4f3454618 # 创建从服务器slave1容器，占用6380端口，因为这是模拟一主多从模式，所以宿主机的端口号必须区分开 # 实际项目中，一般多台Redis服务器会部署在不同的服务器上，所以都可以使用6379端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave1 -p 6380:6380 redis 1d054285a7754e35c130b9951d8f3b2e473c8f989a422c993068cff47d1850f6 # 创建从服务器slave2容器，占用6381端口 PS D:\\code\\blogs\\farb.github.io> docker run -itd --name slave2 -p 6381:6381 redis c1b27efb7e6c112a83fac13fa1df4f8376faa291885933487d46478f260c568c # 通过docker inspect master可以查看主服务器的详细信息，通过IPAddress可知主服务器容器的IP地址是172.17.0.2 # 真实项目中Redis服务器的IP一般是固定的，而通过Docker容器启动的Redis服务器的IP是动态的，可以通过docker inspect 查看 # 进入master容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it master bash root@ee645f3b1c2a:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出角色是主服务器 role:master # 可看出没有从服务器连接 connected_slaves:0 master_failover_state:no-failover master_replid:821b97303c65400fb0d83fcc05b01545326b6083 master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 打开一个新的命令行窗口，进入slave1容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave1 bash root@1d054285a775:/data# redis-cli 127.0.0.1:6379> info replication # Replication # 可以看出和主服务器的信息一样，因为还没有设置主从模式，故此时还没区分主从服务器 role:master connected_slaves:0 master_failover_state:no-failover master_replid:59c0aa90a59be9ee610e0ea16f337f69e5116f1a master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 # 在slave1容器中，通过slaveof命令设置slave1容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 master_link_status:up master_last_io_seconds_ago:8 #... 其他显示省略 # 再次进入master容器中，可以看到master容器中已经有一个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:1 slave0:ip=172.17.0.3,port=6379,state=online,offset=238,lag=1 # 最后进入slave2容器中，通过slaveof命令设置slave2容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息 PS D:\\code\\blogs\\farb.github.io> docker exec -it slave2 bash root@c1b27efb7e6c:/data# redis-cli 127.0.0.1:6379> slaveof 172.17.0.2 6379 OK 127.0.0.1:6379> info replication # Replication # 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号 role:slave master_host:172.17.0.2 master_port:6379 # 再次进入master容器中，可以看到master容器中已经有两个从服务器了，并且能看到从服务器的详细信息 127.0.0.1:6379> info replication # Replication role:master connected_slaves:2 slave0:ip=172.17.0.3,port=6379,state=online,offset=630,lag=0 slave1:ip=172.17.0.4,port=6379,state=online,offset=630,lag=0 # 此时，在两个从服务器中执行get name,都返回nil， # 当在主服务器中执行set name farb，两个从服务器中执行get name，都返回farb 通过配置文件搭建主从集群 除了可以使用slaveof命令搭建主从模式的集群，也可以使用redis.conf配置文件来搭建主从模式的集群。\n"><link rel="shortcut icon" href=/favicon.png><meta name=baidu-site-verification content="codeva-XtyrR4VjKV"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://s3.bmp.ovh/imgs/2024/04/25/1e5e17f5abe2b80d.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Farb's Blog</a></h1><h2 class=site-description>像水一样努力，终会水滴石穿</h2></div></header><ol class=menu-social><li><a href=https://gitee.com/farb target=_blank title=Gitee rel=me><!doctype html><svg t="1713884778674" class="icon" viewBox="0 0 1024 1024" p-id="10647" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M512 1024A512 512 0 11512 0a512 512 0 010 1024zm259.2-568.896H480.32a25.28 25.28.0 00-25.28 25.28v63.232c0 13.952 11.328 25.28 25.28 25.28h177.024c13.952.0 25.28 11.328 25.28 25.28v12.672c0 41.856-33.92 75.84-75.84 75.84H366.592a25.28 25.28.0 01-25.28-25.28V417.216c0-41.92 33.92-75.84 75.84-75.84h353.92a25.28 25.28.0 0025.28-25.344l.064-63.168a25.28 25.28.0 00-25.216-25.28H417.152A189.632 189.632.0 00227.52 417.216v353.92c0 14.016 11.328 25.28 25.28 25.28h372.992a170.624 170.624.0 00170.624-170.624V480.384a25.28 25.28.0 00-25.28-25.28z" fill="#C71D23" p-id="10648"/></svg></a></li><li><a href=https://github.com/farb target=_blank title=GitHub rel=me><!doctype html><svg t="1713884694671" class="icon" viewBox="0 0 1024 1024" p-id="9399" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M64 512c0 195.2 124.8 361.6 300.8 422.4 22.4 6.4 19.2-9.6 19.2-22.4v-76.8c-134.4 16-140.8-73.6-150.4-89.6-19.2-32-60.8-38.4-48-54.4 32-16 64 3.2 99.2 57.6 25.6 38.4 76.8 32 105.6 25.6 6.4-22.4 19.2-44.8 35.2-60.8C281.6 691.2 224 604.8 224 502.4c0-48 16-96 48-131.2-22.4-60.8.0-115.2 3.2-121.6 57.6-6.4 118.4 41.6 124.8 44.8 32-9.6 70.4-12.8 112-12.8s80 6.4 112 12.8c12.8-9.6 67.2-48 121.6-44.8 3.2 6.4 25.6 57.6 6.4 118.4 32 38.4 48 83.2 48 131.2.0 102.4-57.6 188.8-201.6 214.4 22.4 22.4 38.4 54.4 38.4 92.8v112c0 9.6.0 19.2 16 19.2C832 876.8 960 710.4 960 512c0-246.4-201.6-448-448-448S64 265.6 64 512z" fill="#040000" p-id="9400"/></svg></a></li><li><a href=https://leetcode.cn/u/int2147483647 target=_blank title=力扣 rel=me><!doctype html><svg t="1713884461345" class="icon" viewBox="0 0 1024 1024" p-id="4333" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M701.28 766.86a58.9 58.9.0 0183.1 83.52l-102.24 102c-94.3 94.16-248 95.52-344 3.16-.56-.52-43.26-42.4-184.12-180.54-93.72-92-103.06-238.94-14.88-333.36l164.44-176C391.12 172 552.46 161.68 652.54 242.6l149.34 120.78a58.92 58.92.0 01-74 91.76L578.54 334.36c-52.34-42.34-144-36.52-189.06 11.84l-164.44 176c-42.94 46-38.22 120 11.26 168.54l183.26 179.7c49.86 48 130.48 47.3 179.42-1.58z" fill="#FFA116" p-id="4334"/><path d="M452.94 664.7a58.96 58.96.0 010-118h434a58.96 58.96.0 010 118z" fill="#B3B3B3" p-id="4335"/><path d="M534.22 18.68a58.9 58.9.0 1186 80.56L225.1 522.28c-42.92 46-38.22 120 11.24 168.54l182.46 178.9A58.92 58.92.0 01336.46 954L154.06 775.08c-93.7-92-103.04-238.94-14.84-333.36z" p-id="4336"/></svg></a></li><li><a href=https://www.cnblogs.com/farb target=_blank title=博客园 rel=me><!doctype html><svg t="1713884612994" class="icon" viewBox="0 0 1024 1024" p-id="8439" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"><path d="M851.40363594 172.59636406c-187.46181844-187.46181844-491.34545437-187.46181844-678.80727188.0-187.46181844 187.46181844-187.46181844 491.34545437.0 678.80727188 187.46181844 187.46181844 491.34545437 187.46181844 678.80727188.0 187.46181844-187.46181844 187.46181844-491.34545437.0-678.80727188zM387.33090875 728.08727281a47.08363594 47.08363594.0 11-66.63272719-66.50181843 47.08363594 47.08363594.0 0166.63272719 66.50181843zm205.52727281 1.39636313a38.74909125 38.74909125.0 01-76.62545437-11.52h-.04363594a6.54545437 6.54545437.0 00-.04363688.30545531V717.92c.30545438-2.61818156 2.05090875-20.72727281-2.96727281-44.98909125a174.24 174.24.0 00-48.56727281-89.28 172.10181844 172.10181844.0 00-88.8-48.30545438 156.69818156 156.69818156.0 00-42.45818156-2.92363593 38.66181844 38.66181844.0 01-35.38909125-65.32363688 38.61818156 38.61818156.0 0121.12-10.8218175v-.2181825c4.45090875-.74181844 111.14181844-16.45090875 200.33454562 72.74181844 89.01818156 89.01818156 74.18181844 196.14545438 73.44 200.72727281zm175.2 7.59272812a38.74909125 38.74909125.0 01-65.67272719 21.3818175 39.49090875 39.49090875.0 01-11.65090875-33.73090875c.08727281-.34909125 5.10545437-37.48363594-5.06181843-88.97454562C672.36363594 568.37818157 640.37818156 508.85818156 590.72 458.85090875c-50.00727281-49.70181844-109.52727281-81.64363594-176.94545438-94.95272719-51.49090875-10.16727281-88.58181844-5.19272719-89.01818156-5.14909031h.21818156-.04363687a39.92727281 39.92727281.0 01-44.68363594-32.90181844 38.83636406 38.83636406.0 0132.20363594-44.37818156c1.92-.30545438 47.86909125-7.33090875 111.27272719 4.36363594a411.75272719 411.75272719.0 01106.25454562 34.95272718A425.76 425.76.0 01644.61090875 403.04l.91636406.96.96.87272719a425.89090875 425.89090875.0 0182.25454563 114.72c16.40727281 33.6 28.14545437 69.29454562 34.99636312 106.21090875 11.65090875 63.40363594 4.66909125 109.35272719 4.32 111.27272812z" fill="#1296db" p-id="8440"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/%E9%93%BE%E6%8E%A5/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://farb.github.io/ selected>English</option><option value=https://farb.github.io/zh-cn/>中文</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#搭建基于主从复制模式的集群>搭建基于主从复制模式的集群</a><ol><li><a href=#主从复制模式概述>主从复制模式概述</a></li><li><a href=#用命令搭建基于主从复制模式的集群>用命令搭建基于主从复制模式的集群</a></li><li><a href=#通过配置文件搭建主从集群>通过配置文件搭建主从集群</a></li><li><a href=#配置读写分离效果>配置读写分离效果</a></li><li><a href=#用心跳机制提高主从复制的可靠性>用心跳机制提高主从复制的可靠性</a></li><li><a href=#用偏移量检查数据是否一致>用偏移量检查数据是否一致</a></li></ol></li><li><a href=#搭建哨兵模式的集群>搭建哨兵模式的集群</a><ol><li><a href=#哨兵模式概述>哨兵模式概述</a></li></ol></li><li><a href=#搭建哨兵模式集群实战>搭建哨兵模式集群实战</a><ol><li><a href=#哨兵节点的常用配置>哨兵节点的常用配置</a></li><li><a href=#哨兵模式下的故障自动恢复效果>哨兵模式下的故障自动恢复效果</a></li><li><a href=#通过日志观察故障恢复流程>通过日志观察故障恢复流程</a></li><li><a href=#故障节点恢复后的表现>故障节点恢复后的表现</a></li></ol></li><li><a href=#搭建cluster集群>搭建Cluster集群</a><ol><li><a href=#哈希槽和cluster集群>哈希槽和cluster集群</a></li><li><a href=#初步搭建cluster集群>初步搭建cluster集群</a></li><li><a href=#在cluster中读写数据>在cluster中读写数据</a></li><li><a href=#模拟扩容和数据迁移动作>模拟扩容和数据迁移动作</a></li><li><a href=#故障自动恢复>故障自动恢复</a></li><li><a href=#从节点重新恢复为主节点>从节点重新恢复为主节点</a></li><li><a href=#缩容删除节点>缩容：删除节点</a></li><li><a href=#cluster集群中的常用配置>cluster集群中的常用配置</a></li><li><a href=#补充使用cluster-meet>补充：使用cluster meet</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/redis/ style=background-color:#2a9d8f;color:#fff>Redis</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/redis_in_action_07_cluster/>基于Docker的Redis实战--搭建Redis集群</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-07-31</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>28 minute read</time></div></footer></div></header><section class=article-content><h3 id=搭建基于主从复制模式的集群>搭建基于主从复制模式的集群</h3><h4 id=主从复制模式概述>主从复制模式概述</h4><p>主服务器（Master Server）：负责处理客户端的写请求，写入数据后，会复制到一台或多台Redis服务器。<br>从服务器（Slave Server）：负责处理客户端的读请求，从主服务器复制数据。</p><p>主从复制模式的优点：</p><ol><li>写操作集中在主服务器，读操作集中到从服务器，从而实现了读写分离，提升了读写性能。</li><li>因为存在数据备份，因此能提升数据的安全性，当主服务器故障时，可以很快切换到从服务器读取数据。</li></ol><p>如果项目中并发要求不高，或者哪怕从Redis中读不到数据对性能也不会有太大损害，就可以使用一主一从。</p><p><strong>注意要点</strong>：</p><ol><li>一个主服务器可以带一个或多个从服务器，从服务器可以再带从服务器，但在复制时只能把主服务器上的数据复制到从服务器。</li><li>一台从服务器只能跟随一台主服务器，不能出现一从多主的模式。</li><li>Redis2.8以后的版本，采用异步的复制模式，进行主从复制时不会影响主服务器上的读写操作。</li></ol><h4 id=用命令搭建基于主从复制模式的集群>用命令搭建基于主从复制模式的集群</h4><p>这里搭建一个一主二从模式的集群。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 创建主服务器master容器，占用6379端口</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name master -p 6379:6379 redis
</span></span><span class=line><span class=cl>ee645f3b1c2a0c56f5eafb5766701e04c638a4b5b26556cf27735ac4f3454618
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建从服务器slave1容器，占用6380端口，因为这是模拟一主多从模式，所以宿主机的端口号必须区分开</span>
</span></span><span class=line><span class=cl><span class=c1># 实际项目中，一般多台Redis服务器会部署在不同的服务器上，所以都可以使用6379端口</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name slave1 -p 6380:6380 redis
</span></span><span class=line><span class=cl>1d054285a7754e35c130b9951d8f3b2e473c8f989a422c993068cff47d1850f6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建从服务器slave2容器，占用6381端口</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name slave2 -p 6381:6381 redis
</span></span><span class=line><span class=cl>c1b27efb7e6c112a83fac13fa1df4f8376faa291885933487d46478f260c568c
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过docker inspect master可以查看主服务器的详细信息，通过IPAddress可知主服务器容器的IP地址是172.17.0.2</span>
</span></span><span class=line><span class=cl><span class=c1># 真实项目中Redis服务器的IP一般是固定的，而通过Docker容器启动的Redis服务器的IP是动态的，可以通过docker inspect 查看</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入master容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it master bash
</span></span><span class=line><span class=cl>root@ee645f3b1c2a:/data# redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看出角色是主服务器</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl><span class=c1># 可看出没有从服务器连接</span>
</span></span><span class=line><span class=cl>connected_slaves:0
</span></span><span class=line><span class=cl>master_failover_state:no-failover
</span></span><span class=line><span class=cl>master_replid:821b97303c65400fb0d83fcc05b01545326b6083
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>master_repl_offset:0
</span></span><span class=line><span class=cl>second_repl_offset:-1
</span></span><span class=line><span class=cl>repl_backlog_active:0
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:0
</span></span><span class=line><span class=cl>repl_backlog_histlen:0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打开一个新的命令行窗口，进入slave1容器，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it slave1 bash
</span></span><span class=line><span class=cl>root@1d054285a775:/data# redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看出和主服务器的信息一样，因为还没有设置主从模式，故此时还没区分主从服务器</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:0
</span></span><span class=line><span class=cl>master_failover_state:no-failover
</span></span><span class=line><span class=cl>master_replid:59c0aa90a59be9ee610e0ea16f337f69e5116f1a
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>master_repl_offset:0
</span></span><span class=line><span class=cl>second_repl_offset:-1
</span></span><span class=line><span class=cl>repl_backlog_active:0
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:0
</span></span><span class=line><span class=cl>repl_backlog_histlen:0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在slave1容器中，通过slaveof命令设置slave1容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; slaveof 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.2
</span></span><span class=line><span class=cl>master_port:6379
</span></span><span class=line><span class=cl>master_link_status:up
</span></span><span class=line><span class=cl>master_last_io_seconds_ago:8
</span></span><span class=line><span class=cl><span class=c1>#... 其他显示省略</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再次进入master容器中，可以看到master容器中已经有一个从服务器了，并且能看到从服务器的详细信息</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:1
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.3,port<span class=o>=</span>6379,state<span class=o>=</span>online,offset<span class=o>=</span>238,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 最后进入slave2容器中，通过slaveof命令设置slave2容器为master容器的从服务器，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it slave2 bash
</span></span><span class=line><span class=cl>root@c1b27efb7e6c:/data# redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; slaveof 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.2
</span></span><span class=line><span class=cl>master_port:6379
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再次进入master容器中，可以看到master容器中已经有两个从服务器了，并且能看到从服务器的详细信息</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.3,port<span class=o>=</span>6379,state<span class=o>=</span>online,offset<span class=o>=</span>630,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6379,state<span class=o>=</span>online,offset<span class=o>=</span>630,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 此时，在两个从服务器中执行get name,都返回nil，</span>
</span></span><span class=line><span class=cl><span class=c1># 当在主服务器中执行set name farb，两个从服务器中执行get name，都返回farb</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=通过配置文件搭建主从集群>通过配置文件搭建主从集群</h4><p><strong>除了可以使用slaveof命令搭建主从模式的集群，也可以使用redis.conf配置文件来搭建主从模式的集群。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 强制删除上面创建的一主而从的容器，防止影响后面的实验</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker rm -f  master slave1 slave2
</span></span><span class=line><span class=cl>master
</span></span><span class=line><span class=cl>slave1
</span></span><span class=line><span class=cl>slave2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建主服务器master容器，占用6379端口,通过docker inpect命令查看主服务器的详细信息，通过IPAddress可知主服务器容器的IP地址是172.17.0.2</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-master -p 6379:6379 redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在redisSlave1.conf中配置如下：</span>
</span></span><span class=line><span class=cl>port <span class=m>6380</span> <span class=c1># redis-slave1服务器的端口号</span>
</span></span><span class=line><span class=cl>slaveof 172.17.0.2 <span class=m>6379</span> <span class=c1># redis-slave1服务器的master服务器的IP地址和端口号</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建从服务器redis-slave1容器,并使用-v绑定redisSlave1.conf文件到容器中</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-slave1 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfMasterSlave:/redisConfig:rw redis redis-server /redisConfig/redisSlave1.conf
</span></span><span class=line><span class=cl>1daa79fc05a9087ad4167ec5c4a5899935fbbb27c354667c94b0c8bf1100d207
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入redis-slave1容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it redis-slave1 bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># redics-cli 默认使用的地址是127.0.0.1:6379，所以会连接失败</span>
</span></span><span class=line><span class=cl>root@1daa79fc05a9:/data# redis-cli
</span></span><span class=line><span class=cl>Could not connect to Redis at 127.0.0.1:6379: Connection refused
</span></span><span class=line><span class=cl>not connected&gt;
</span></span><span class=line><span class=cl><span class=c1># 当前redisSlave1.conf中配置的端口是6380，所以需要通过-h指定主机地址，通过-p指定端口号</span>
</span></span><span class=line><span class=cl>root@1daa79fc05a9:/data# redis-cli -h localhost -p <span class=m>6380</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看出角色是slave服务器，并且可以知道master服务器的IP地址和端口号</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 同样的方式创建redis-slave2服务器，在redisSlave2.conf中配置如下：</span>
</span></span><span class=line><span class=cl>port <span class=m>6381</span>
</span></span><span class=line><span class=cl>slaveof 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建从服务器redis-slave2容器,并使用-v绑定redisSlave2.conf文件到容器中</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-slave2 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfMasterSlave:/redisConfig:rw redis redis-server /redisConfig/redisSlave2.conf
</span></span><span class=line><span class=cl>8636a97f6e2d7ba10231b330d248f4e37ff2f2477ae74c87d1aae18227f44c99
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入redis-slave2容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it redis-slave2 bash
</span></span><span class=line><span class=cl>root@8636a97f6e2d:/data# redis-cli -h localhost -p <span class=m>6381</span>
</span></span><span class=line><span class=cl>localhost:6381&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.2
</span></span><span class=line><span class=cl>master_port:6379
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再次回到redis-master容器中，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看到已经和redis-slave1和redis-slave2建立了主从模式的关系</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.3,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>14,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>14,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 此时，在redis-master执行set age 18，redis-slave1和redis-slave2执行get age，都返回18</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=配置读写分离效果>配置读写分离效果</h4><blockquote><p>默认搭建好主从复制模式的集群后， 主服务器是可读可写的，而从服务器是只读的。如果对从服务器执行set等写命令，会报错。当然，如果确实需要，也可以将从服务器的只读属性设置为可读可写。</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入redis-slave1容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.2
</span></span><span class=line><span class=cl>master_port:6379
</span></span><span class=line><span class=cl>master_link_status:down
</span></span><span class=line><span class=cl>master_last_io_seconds_ago:-1
</span></span><span class=line><span class=cl>master_sync_in_progress:0
</span></span><span class=line><span class=cl>slave_read_repl_offset:14
</span></span><span class=line><span class=cl>slave_repl_offset:14
</span></span><span class=line><span class=cl>master_link_down_since_seconds:-1
</span></span><span class=line><span class=cl>slave_priority:100
</span></span><span class=line><span class=cl><span class=c1># 可以看到slave_read_only属性为1，表示从服务器是只读的</span>
</span></span><span class=line><span class=cl>slave_read_only:1
</span></span><span class=line><span class=cl>replica_announced:1
</span></span><span class=line><span class=cl>connected_slaves:0
</span></span><span class=line><span class=cl>master_failover_state:no-failover
</span></span><span class=line><span class=cl>master_replid:0d4ffddabfc229c371de8e1ee4d411424ad14261
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span><span class=line><span class=cl>master_repl_offset:14
</span></span><span class=line><span class=cl>second_repl_offset:-1
</span></span><span class=line><span class=cl>repl_backlog_active:0
</span></span><span class=line><span class=cl>repl_backlog_size:1048576
</span></span><span class=line><span class=cl>repl_backlog_first_byte_offset:0
</span></span><span class=line><span class=cl>repl_backlog_histlen:0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认为只读模式，所以无法执行写操作</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; <span class=nb>set</span> sex male
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> READONLY You can<span class=err>&#39;</span>t write against a <span class=nb>read</span> only replica.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过redis.conf配置文件，将slave-read-only属性设置为no，表示从服务器是可读可写的</span>
</span></span><span class=line><span class=cl>slave-read-only no
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#重启redis-slave1容器，通过redis-cli命令进入Redis客户端，并再次执行set sex male</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; get sex
</span></span><span class=line><span class=cl><span class=o>(</span>nil<span class=o>)</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; <span class=nb>set</span> sex male
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>localhost:6380&gt; get sex
</span></span><span class=line><span class=cl><span class=s2>&#34;male&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分别进入redis-master和redis-slave2容器中，执行get sex均返回nil,说明写入从服务器的数据不会进行任何同步操作。</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=用心跳机制提高主从复制的可靠性>用心跳机制提高主从复制的可靠性</h4><blockquote><p>主从复制的模式里，从服务器会默认以一秒一次的频率向主服务器发送REPLCONF ACK命令，来确保主服务器和从服务器之间的连接。这种定时交互命令确保连接的机制叫做“心跳”机制。在主服务器中执行info replication命令，可以看到从属于它的从服务器的“心跳”状态</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.3,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>14,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>14,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过上面的lag=0，可知主从服务器之间连接畅通，延迟都是0秒</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建主服务器的配置文件redisMaster.conf，配置如下：</span>
</span></span><span class=line><span class=cl>min-slaves-to-write <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=c1># 连接到主服务器的从服务器最少需要2个，否则主服务器将拒绝同步操作</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>min-slaves-max-lag <span class=m>15</span>
</span></span><span class=line><span class=cl><span class=c1># 从服务器与主服务器之间的最大延迟不能超过15秒</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以上两个条件是“或”的关系，只要一个条件不满足就停止主从复制的操作。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重新创建并启动redis-master容器，并使用-v绑定redisMaster.conf文件到容器中</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-master -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfMasterSlave:/redisConfig:rw -p 6379:6379 redis redis-server /redisConfig/redisMaster.conf 
</span></span><span class=line><span class=cl>24ea09c6e60202c13e04ff52339e397dcc539da6376444e03d9fe66e58be59d3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主服务器写入set k1 v1 成功后，redis-slave1和redis-slave2均可读取数据</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; <span class=nb>set</span> k1 v1
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># shutdown redis-slave2服务器后，再次在主服务器执行set命令，发现报错。因为违反了配置中的min-slaves-to-write 2</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; <span class=nb>set</span> k2 v2
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> NOREPLICAS Not enough good replicas to write.
</span></span></code></pre></td></tr></table></div></div><h4 id=用偏移量检查数据是否一致>用偏移量检查数据是否一致</h4><p><strong>master_repl_offset</strong>：主服务器向从服务器发送的字节数<br><strong>slave_repl_offset</strong>: 从服务器接收到来来自主服务器发送的字节数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入redis-master容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看到主服务器向从服务器发送了字节数906</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>min_slaves_good_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.2,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>906,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>906,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>master_repl_offset:906
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分别进入redis-slave1容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息</span>
</span></span><span class=line><span class=cl><span class=c1># 应该可以看到slave_repl_offset的值也是906（前提是没有对从服务器执行写操作，且主从服务器数据一直同步，否则可能会不一致）</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=搭建哨兵模式的集群>搭建哨兵模式的集群</h3><blockquote><p>基于主从复制+读写分离模式的集群，一旦主服务器发生故障，则需要手动切换到从服务器上，同时需要重新设置主从关系。如果采用哨兵模式，则不需要手动切换，当主服务器发生故障时，哨兵会自动切换到从服务器上，实现“故障自动恢复”的效果，保证集群的高可用性。</p></blockquote><h4 id=哨兵模式概述>哨兵模式概述</h4><blockquote><p>哨兵机制一般和主从复制模式整合使用，在基于哨兵的模式里会在一台或多台服务器上引入哨兵进程，这些节点叫哨兵节点。
哨兵节点一般不存储数据，主要作用是监控主从模式里的主服务器节点(哨兵节点之间也相互监控)。当哨兵节点监控的主服务器发生故障时，哨兵节点会主导“故障自动恢复”的过程，具体来讲就是会通过选举模式在该主服务器下属的从服务器中选择一个作为新的主服务器，并完成相应的数据和配置等更改操作。
基于哨兵模式的集群，可以让故障自动恢复，从而提升系统的可用性。实际项目中一般会配置多个主从模式集群，所以需要引入多个哨兵节点。</p></blockquote><h3 id=搭建哨兵模式集群实战>搭建哨兵模式集群实战</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 清理环境，删除所有容器避免影响，使用 docker rm $(docker ps -aq) 或 docker container prune -f 命令</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker rm <span class=k>$(</span>docker ps -aq<span class=k>)</span>
</span></span><span class=line><span class=cl>2f25343c996e
</span></span><span class=line><span class=cl>aa62f3456cb4
</span></span><span class=line><span class=cl>25bd36e835b9
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按照上面的实战，再次创建一个一主二从的主从复制模式</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-master -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfSentinel:/redisConfig:rw -p 6379:6379 redis redis-server /redisConfig/redisMaster.conf
</span></span><span class=line><span class=cl>8227be97fad3ca13872c2c304d0f49fd918521ed31ca5ea51914d9bd7ed701a6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-slave1 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfSentinel:/redisConfig:rw -p 6380:6380 redis redis-server /redisConfig/redisSlave1.conf
</span></span><span class=line><span class=cl>4ce5f884fb26bd3760047e4c93b95356b3b70048f423c2fdff40e8cb8ec76b37
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name redis-slave2 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfSentinel:/redisConfig:rw -p 6381:6381 redis redis-server /redisConfig/redisSlave2.conf
</span></span><span class=line><span class=cl>6470580ea30f9903aa64b7d54ca5ecbd8777cbef0cea8ecd891cdcd07337793a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入redis-master容器中，通过redis-cli命令进入Redis客户端，通过info replication命令查看Redis服务器的主从模式状态信息,确保主从复制模式已经搭建成功</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it redis-master bash
</span></span><span class=line><span class=cl>root@8227be97fad3:/data# redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>min_slaves_good_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.3,port<span class=o>=</span>6380,state<span class=o>=</span>online,offset<span class=o>=</span>196,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>196,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>master_failover_state:no-failover
</span></span><span class=line><span class=cl>master_replid:65bf7b2a0d40228c859adf93672af1fa88601443
</span></span><span class=line><span class=cl>master_replid2:0000000000000000000000000000000000000000
</span></span></code></pre></td></tr></table></div></div><p><strong>基础的主从复制模式搭建完成后，下面开始哨兵的搭建</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>port <span class=m>16379</span>
</span></span><span class=line><span class=cl><span class=c1># 哨兵节点的工作端口是16379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sentinel monitor master 172.17.0.2 <span class=m>6379</span> <span class=m>2</span>
</span></span><span class=line><span class=cl><span class=c1># 哨兵节点监控主服务器，主机ip是172.17.0.2，端口是6379，集群中至少2个哨兵节点才能确定该主服务器是否故障</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dir /
</span></span><span class=line><span class=cl>logfile <span class=s2>&#34;sentinel1.log&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 哨兵节点日志文件位置和名称</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建并启动哨兵节点容器，通过-v挂载了D:\ArchitectPracticer\Redis\RedisConfSentinel目录</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name sentinel1 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfSentinel:/redisConfig:rw -p 16379:16379 redis redis-sentinel /redisConfig/sentinel1.conf   
</span></span><span class=line><span class=cl>59caeda82a6111e9e1c324e0c580e2591f4a4c7ba3dcc52d4f5e3cddb9c6e463
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入sentinel1容器中，通过redis-cli命令进入Redis客户端，通过info sentinel命令查看Redis服务器的哨兵模式状态信息</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it sentinel1 bash
</span></span><span class=line><span class=cl>root@59caeda82a61:/data# redis-cli -h localhost -p <span class=m>16379</span>
</span></span><span class=line><span class=cl>localhost:16379&gt; info sentinel
</span></span><span class=line><span class=cl><span class=c1># Sentinel</span>
</span></span><span class=line><span class=cl>sentinel_masters:1
</span></span><span class=line><span class=cl>sentinel_tilt:0
</span></span><span class=line><span class=cl>sentinel_tilt_since_seconds:-1
</span></span><span class=line><span class=cl>sentinel_running_scripts:0
</span></span><span class=line><span class=cl>sentinel_scripts_queue_length:0
</span></span><span class=line><span class=cl>sentinel_simulate_failure_flags:0
</span></span><span class=line><span class=cl>master0:name<span class=o>=</span>master,status<span class=o>=</span>ok,address<span class=o>=</span>172.17.0.2:6379,slaves<span class=o>=</span>2,sentinels<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># 最后一句可以看到该主服务器的状态是ok，说明哨兵节点已经成功监控到主服务器，并且该主服务器的ip和端口也可看到，该主服务器下有2个从服务器，并且有一个哨兵节点</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 同样地，创建sentinel2.conf配置文件</span>
</span></span><span class=line><span class=cl>port <span class=m>16380</span>
</span></span><span class=line><span class=cl>sentinel resolve-hostnames yes
</span></span><span class=line><span class=cl>sentinel monitor master 172.17.0.2 <span class=m>6379</span> <span class=m>2</span>
</span></span><span class=line><span class=cl>dir <span class=s2>&#34;/&#34;</span>
</span></span><span class=line><span class=cl>logfile <span class=s2>&#34;sentinel2.log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建并启动第二个哨兵节点容器，通过-v挂载了D:\ArchitectPracticer\Redis\RedisConfSentinel目录</span>
</span></span><span class=line><span class=cl>docker run -itd --name sentinel2 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfSentinel:/redisConfig:rw -p 16380:16380 redis redis-sentinel /redisConfig/sentinel2.conf      
</span></span><span class=line><span class=cl>2a742a70e80989b868a394856e95d97c58be40e1b892025463ab22646f85c759
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it sentinel2 bash
</span></span><span class=line><span class=cl>root@2a742a70e809:/data# redis-cli -h localhost -p <span class=m>16380</span>
</span></span><span class=line><span class=cl>localhost:16380&gt; info sentinel
</span></span><span class=line><span class=cl><span class=c1># Sentinel</span>
</span></span><span class=line><span class=cl>sentinel_masters:1
</span></span><span class=line><span class=cl>sentinel_tilt:0
</span></span><span class=line><span class=cl>sentinel_tilt_since_seconds:-1
</span></span><span class=line><span class=cl>sentinel_running_scripts:0
</span></span><span class=line><span class=cl>sentinel_scripts_queue_length:0
</span></span><span class=line><span class=cl>sentinel_simulate_failure_flags:0
</span></span><span class=line><span class=cl>master0:name<span class=o>=</span>master,status<span class=o>=</span>ok,address<span class=o>=</span>172.17.0.2:6379,slaves<span class=o>=</span>2,sentinels<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl><span class=c1># 最后一句可以看到该主服务器的状态是ok，说明哨兵节点已经成功监控到主服务器，并且该主服务器的ip和端口也可看到，该主服务器下有2个从服务器，并且有2个哨兵节点</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>至此，基于哨兵的一主二从的Redis集群已经搭建完成：两个哨兵节点sentinel1和sentinel2同时监控redis-master主服务器，主服务器下挂着两个从服务器redis-slave1和redis-slave2，并且主服务器和两个从服务器之间依然存在“主从复制模式”。实际项目里可以让哨兵节点监控多个集群</strong></p><h4 id=哨兵节点的常用配置>哨兵节点的常用配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 哨兵节点监控主服务器后，如果主服务器挂了，需要多久才能确定该主服务器已经故障 ，</span>
</span></span><span class=line><span class=cl><span class=c1># master是哨兵节点监控的服务器名称，需要和sentinel monitor命令中设置的服务器名称master一致</span>
</span></span><span class=line><span class=cl><span class=c1># 之前配置了 sentinel monitor master 172.17.0.2 6379 2，因而至少2个哨兵节点都超过60s没有收到master的响应，才能确定该主服务器已经故障</span>
</span></span><span class=line><span class=cl>sentinel down-after-milliseconds master <span class=m>60000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 哨兵节点监控主服务器后，如果主服务器故障了，必须在180s内自动切换到其他从服务器，否则认定本次恢复动作失败。</span>
</span></span><span class=line><span class=cl>sentinel failover-timeout master <span class=m>180000</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=哨兵模式下的故障自动恢复效果>哨兵模式下的故障自动恢复效果</h4><p><strong>将redis-server容器停止或通过shutdown命令关闭redis-master，通过info sentinel命令观察哨兵节点的日志，通过info replication命令观察主从复制的状态信息，来确认哨兵节点的故障自动恢复效果</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 关闭redis-master容器</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; shutdown
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入sentinel1容器，通过info sentinel命令观察哨兵节点的日志，发现主服务器已经由之前的主服务器172.17.0.2:6379，变成了新的主服务器172.17.0.3:6380</span>
</span></span><span class=line><span class=cl>localhost:16379&gt; info sentinel
</span></span><span class=line><span class=cl><span class=c1># Sentinel</span>
</span></span><span class=line><span class=cl>sentinel_masters:1
</span></span><span class=line><span class=cl>sentinel_tilt:0
</span></span><span class=line><span class=cl>sentinel_tilt_since_seconds:-1
</span></span><span class=line><span class=cl>sentinel_running_scripts:0
</span></span><span class=line><span class=cl>sentinel_scripts_queue_length:0
</span></span><span class=line><span class=cl>sentinel_simulate_failure_flags:0
</span></span><span class=line><span class=cl>master0:name<span class=o>=</span>master,status<span class=o>=</span>ok,address<span class=o>=</span>172.17.0.3:6380,slaves<span class=o>=</span>2,sentinels<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#进入sentinel2容器，能够看到相同的信息。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入redis-slave1容器，通过info replication命令观察主从复制的状态信息，发现redis-slave1已经成为主服务，并且之前的redis-slave2已经成为从服务器</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:1
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>315538,lag<span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入redis-slave2容器，通过info replication命令观察主从复制的状态信息，也发现redis-slave1已经成为主服务器</span>
</span></span><span class=line><span class=cl>redis-cli -h localhost -p <span class=m>6381</span>
</span></span><span class=line><span class=cl>localhost:6381&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:slave
</span></span><span class=line><span class=cl>master_host:172.17.0.3
</span></span><span class=line><span class=cl>master_port:6380
</span></span><span class=line><span class=cl>master_link_status:up
</span></span></code></pre></td></tr></table></div></div><p><strong>通过上述实践，发现故障已经自动恢复</strong></p><h4 id=通过日志观察故障恢复流程>通过日志观察故障恢复流程</h4><p>通过观察哨兵的日志，查看故障自动恢复的流程</p><p>关键词：</p><ul><li>sdown：主观宕机subjective down</li><li>odown: 客观宕机objective down</li><li>failover: 故障转移</li><li>vote-for-leader： 领导选举</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 先查看sentinel2.log日志</span>
</span></span><span class=line><span class=cl>root@2a742a70e809:/data# cat /sentinel2.log
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * Redis <span class=nv>version</span><span class=o>=</span>7.2.5, <span class=nv>bits</span><span class=o>=</span>64, <span class=nv>commit</span><span class=o>=</span>00000000, <span class=nv>modified</span><span class=o>=</span>0, <span class=nv>pid</span><span class=o>=</span>1, just started
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * Configuration loaded
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * monotonic clock: POSIX clock_gettime
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * Running <span class=nv>mode</span><span class=o>=</span>sentinel, <span class=nv>port</span><span class=o>=</span>16380.
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 * Sentinel ID is 750555c54a6c4e294749888502b1644dfd0f3ac7
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.749 <span class=c1># +monitor master master 172.17.0.2 6379 quorum 2</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.751 * +slave slave 172.17.0.3:6380 172.17.0.3 <span class=m>6380</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.756 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.756 * +slave slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:13.760 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:14.780 * +sentinel sentinel fc41e2130b8b8896db18204e1b1ca868161369e2 172.17.0.5 <span class=m>16379</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 03:44:14.784 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主服务器redis-master被sentinel2节点主观下线</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.656 <span class=c1># +sdown master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl><span class=c1># 主服务器redis-master被sentinel2节点客观下线，因为此时sentinel1节点也认为主观下线，共有两个节点满足主观下线条件quorum 2/2，从而客观下线</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.727 <span class=c1># +odown master master 172.17.0.2 6379 #quorum 2/2</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.727 <span class=c1># +new-epoch 1</span>
</span></span><span class=line><span class=cl><span class=c1># 尝试故障转移</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.727 <span class=c1># +try-failover master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.732 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl><span class=c1># 领导选举</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.732 <span class=c1># +vote-for-leader 750555c54a6c4e294749888502b1644dfd0f3ac7 1</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.738 * fc41e2130b8b8896db18204e1b1ca868161369e2 voted <span class=k>for</span> 750555c54a6c4e294749888502b1644dfd0f3ac7 <span class=m>1</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.815 <span class=c1># +elected-leader master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.815 <span class=c1># +failover-state-select-slave master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.887 <span class=c1># +selected-slave slave 172.17.0.3:6380 172.17.0.3 6380 @ master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.887 * +failover-state-send-slaveof-noone slave 172.17.0.3:6380 172.17.0.3 <span class=m>6380</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.958 * +failover-state-wait-promotion slave 172.17.0.3:6380 172.17.0.3 <span class=m>6380</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.604 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.604 <span class=c1># +promoted-slave slave 172.17.0.3:6380 172.17.0.3 6380 @ master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.604 <span class=c1># +failover-state-reconf-slaves master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.662 * +slave-reconf-sent slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.880 <span class=c1># -odown master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.656 * +slave-reconf-inprog slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.656 * +slave-reconf-done slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.2 <span class=m>6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.739 <span class=c1># +failover-end master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl><span class=c1># 切换主服务器到新的主服务器172.17.0.3:6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.739 <span class=c1># +switch-master master 172.17.0.2 6379 172.17.0.3 6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.739 * +slave slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.3 <span class=m>6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.739 * +slave slave 172.17.0.2:6379 172.17.0.2 <span class=m>6379</span> @ master 172.17.0.3 <span class=m>6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:56.743 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:19:26.747 <span class=c1># +sdown slave 172.17.0.2:6379 172.17.0.2 6379 @ master 172.17.0.3 6380</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看senttinel1.log日志</span>
</span></span><span class=line><span class=cl><span class=c1># 主服务器redis-master被sentinel1节点主观下线,可以看到比sentinel2节点快了1毫秒</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.655 <span class=c1># +sdown master master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.735 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.735 <span class=c1># +new-epoch 1</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.738 * Sentinel new configuration saved on disk
</span></span><span class=line><span class=cl><span class=c1># 领导选举</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:54.738 <span class=c1># +vote-for-leader 750555c54a6c4e294749888502b1644dfd0f3ac7 1</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.663 <span class=c1># +config-update-from sentinel 750555c54a6c4e294749888502b1644dfd0f3ac7 172.17.0.6 16380 @ master 172.17.0.2 6379</span>
</span></span><span class=line><span class=cl><span class=c1># 切换主服务器到新的主服务器172.17.0.3:6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.663 <span class=c1># +switch-master master 172.17.0.2 6379 172.17.0.3 6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.663 * +slave slave 172.17.0.4:6381 172.17.0.4 <span class=m>6381</span> @ master 172.17.0.3 <span class=m>6380</span>
</span></span><span class=line><span class=cl>1:X <span class=m>03</span> Aug <span class=m>2024</span> 04:18:55.663 * +slave slave 172.17.0.2:6379 172.17.0.2 <span class=m>6379</span> @ master 172.17.0.3 <span class=m>6380</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 由于只能由一个哨兵节点完成故障自动恢复，因此如果有多个哨兵节点同时监控到主服务器失效，那么最终只有一个哨兵节点通过竞争得到故障恢复的权力。</span>
</span></span><span class=line><span class=cl><span class=c1># 从上面的日志中，可以看到故障恢复的权力已经被sentinel2节点竞争得到，sentinel1只能在sdown之后处于停留状态，待sentinel2节点完成故障恢复之后重新切换到新的主服务器节点，继续监控新的主服务器节点和对应的从服务器节点  。</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=故障节点恢复后的表现>故障节点恢复后的表现</h4><p>从上面的日志中可以看到redis-master服务器处于失效状态，但是在新的主从复制集群里会把该服务器当作从服务器。再重新启动redis-master容器，模拟故障排除后的效果。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 可以看到，redis-master重启后，自动以slave的身份接入。</span>
</span></span><span class=line><span class=cl>redis-cli -h localhost -p <span class=m>6380</span>
</span></span><span class=line><span class=cl>localhost:6380&gt; info replication
</span></span><span class=line><span class=cl><span class=c1># Replication</span>
</span></span><span class=line><span class=cl>role:master
</span></span><span class=line><span class=cl>connected_slaves:2
</span></span><span class=line><span class=cl>slave0:ip<span class=o>=</span>172.17.0.4,port<span class=o>=</span>6381,state<span class=o>=</span>online,offset<span class=o>=</span>3096199,lag<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>slave1:ip<span class=o>=</span>172.17.0.2,port<span class=o>=</span>6379,state<span class=o>=</span>online,offset<span class=o>=</span>3096199,lag<span class=o>=</span><span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>由上可知，哨兵节点不仅能自动恢复故障，而且当故障节点恢复后，会自动把它加入到集群中，而无需人工干预。与简单的主从复制模式集群相比，哨兵模式的集群能更好地提升系统的可靠性。</strong></p><h3 id=搭建cluster集群>搭建Cluster集群</h3><blockquote><p>相比哨兵模式，cluster集群能支持扩容，且无需额外的节点来监控状态。</p></blockquote><h4 id=哈希槽和cluster集群>哈希槽和cluster集群</h4><p><strong>cluster集群里有16384个哈希槽（hash slot），在写入数据时，会先用CRC16算法对key进行运算，并用16384对运算结果进行模运算，最终结果作为哈希槽的索引，将数据存入对应的哈希槽中。<code>slotIndex=Hash_Slot=CRC16(key) % 16384</code>。这里说的cluster集群有16384个哈希槽，并不意味着集群中一定要有16374个节点，哈希槽是虚拟的，是会被分配到若干台集群中的机器中的。</strong></p><p>比如，某cluster集群由三台Redis服务器组成，平均每台服务器可以分配16384/3=5461个哈希槽。由于哈希槽编号从0开始，所以编号[0,5460]会分配给第一台服务器，编号[5461,10922]分配给第二台服务器，[10923,16383]分配给第三台服务器。同理，如果有6台Redis服务器，平均每个服务器可以分配16384/6=2730个哈希槽。此外，cluster也支持主从复制，即分配到一定数量的Redis主服务器也可以携带一个或多个从服务器。如下图是一个三主三从的cluster集群。</p><p><img src=https://s3.bmp.ovh/imgs/2024/08/04/557c7a6fd895766b.png loading=lazy></p><h4 id=初步搭建cluster集群>初步搭建cluster集群</h4><p>搭建如上图所示的三主三从的cluster集群，其他类型的依次类推。</p><p>** 1.首先创建三主三从服务器的配置文件**</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 主服务器1的配置文件 clusterMaster1.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>6379</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl><span class=c1># 日志存放目录</span>
</span></span><span class=line><span class=cl>logfile clusterMaster1.log
</span></span><span class=line><span class=cl><span class=c1># 日志文件名</span>
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl><span class=c1># 开启集群模式</span>
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterMaster1.conf
</span></span><span class=line><span class=cl><span class=c1># 集群相关的配置文件，会自动生成</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主服务器2的配置文件 clusterMaster2.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>6380</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterMaster2.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterMaster2.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主服务器3的配置文件 clusterMaster3.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>6381</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterMaster3.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterMaster3.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从服务器1的配置文件 clusterSlave1.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>16379</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterSlave1.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterSlaver1.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从服务器2的配置文件 clusterSlave2.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>16380</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterSlave2.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterSlave2.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从服务器3的配置文件 clusterSlave3.conf</span>
</span></span><span class=line><span class=cl>port <span class=m>16381</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusteSlave3.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterSlave3.conf
</span></span></code></pre></td></tr></table></div></div><p><strong>2. 启动集群中的每个容器</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 分别启动clusterMaster1 clusterMaster2 clusterMaster3 clusterSlave1 clusterSlave2 clusterSlave3 6个容器</span>
</span></span><span class=line><span class=cl><span class=c1># 每个容器只是容器名称，端口号和配置文件不同</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterMaster1 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 6379:6379 redis redis-server /redisConfig/clusterMaster1.conf  
</span></span><span class=line><span class=cl>fb368ad5ad39950afced6ca59c9be133d8440623f0f4aedd008cec2b6bcdd735
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterMaster2 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 6380:6380 redis redis-server /redisConfig/clusterMaster2.conf
</span></span><span class=line><span class=cl>ccb9bf970d30c6273b5d7b9e82d3729520c53cb440a49766cc4e0c21f55d23d8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterMaster3 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 6381:6381 redis redis-server /redisConfig/clusterMaster3.conf
</span></span><span class=line><span class=cl>dcd5903265bf75182ded211dfb7728f97fc734f926bcba813332fe7cdb898aeb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterSlave1 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 16379:16379 redis redis-server /redisConfig/clusterSlave1.conf 
</span></span><span class=line><span class=cl>5d2ecf9131f7069cf410940fad6a85a48e7292fac4b709cc60116ebd57ffca92
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterSlave2 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 16380:16380 redis redis-server /redisConfig/clusterSlave2.conf
</span></span><span class=line><span class=cl>44e2e24b798af85be78c2c364e15440cf11447a645567d527833a5b95548dbef
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd --name clusterSlave3 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw -p 16381:16381 redis redis-server /redisConfig/clusterSlave3.conf
</span></span><span class=line><span class=cl>ef29a379b55728b20833f4d2b90846d8de034ae9652a76c0acedbd80c53ee5ce
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看容器列表，确保6个容器都处于Up状态</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker ps 
</span></span><span class=line><span class=cl>CONTAINER ID   IMAGE     COMMAND                   CREATED         STATUS         PORTS                                NAMES
</span></span><span class=line><span class=cl>ef29a379b557   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>3</span> minutes ago   Up <span class=m>3</span> minutes   6379/tcp, 0.0.0.0:16381-&gt;16381/tcp   clusterSlave3
</span></span><span class=line><span class=cl>44e2e24b798a   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>4</span> minutes ago   Up <span class=m>4</span> minutes   6379/tcp, 0.0.0.0:16380-&gt;16380/tcp   clusterSlave2
</span></span><span class=line><span class=cl>5d2ecf9131f7   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>4</span> minutes ago   Up <span class=m>4</span> minutes   6379/tcp, 0.0.0.0:16379-&gt;16379/tcp   clusterSlave1
</span></span><span class=line><span class=cl>dcd5903265bf   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>5</span> minutes ago   Up <span class=m>5</span> minutes   6379/tcp, 0.0.0.0:6381-&gt;6381/tcp     clusterMaster3
</span></span><span class=line><span class=cl>ccb9bf970d30   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>6</span> minutes ago   Up <span class=m>6</span> minutes   6379/tcp, 0.0.0.0:6380-&gt;6380/tcp     clusterMaster2
</span></span><span class=line><span class=cl>fb368ad5ad39   redis     <span class=s2>&#34;docker-entrypoint.s…&#34;</span>   <span class=m>2</span> hours ago     Up <span class=m>2</span> hours     0.0.0.0:6379-&gt;6379/tcp               clusterMaster1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 打开nodes-clusterMaster1.conf文件，如下：</span>
</span></span><span class=line><span class=cl>8b9e6e09898be857fcd33e4a2611c42268ce7b1c :0@0,,tls-port<span class=o>=</span>0,shard-id<span class=o>=</span>358d229be66be4999268253234d3bb58623dbe83 myself,master - <span class=m>0</span> <span class=m>0</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>vars currentEpoch <span class=m>0</span> lastVoteEpoch <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看到，当前节点属于master节点，只连接到myself自身，没同其他节点关联。其他nodes-*.conf文件类似，都是master节点，没有关联其他节点。稍后将用meet命令关联。</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>3.使用redis-cli &ndash;cluster create命令创建集群</strong>
<strong>使用 <code>docker inspect -f '{{.NetworkSettings.IPAddress}}' containerName</code> 查看容器的IP地址</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterMaster1
</span></span><span class=line><span class=cl>172.17.0.2
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterMaster2
</span></span><span class=line><span class=cl>172.17.0.3
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterMaster3
</span></span><span class=line><span class=cl>172.17.0.4
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterSlave1 
</span></span><span class=line><span class=cl>172.17.0.5
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterSlave2
</span></span><span class=line><span class=cl>172.17.0.6
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s1>&#39;{{.NetworkSettings.IPAddress}}&#39;</span> clusterSlave3
</span></span><span class=line><span class=cl>172.17.0.7
</span></span></code></pre></td></tr></table></div></div><p>为便于查看，列出统计表格如下：</p><div class=table-wrapper><table><thead><tr><th>节点名称</th><th>IP地址</th><th>端口</th><th>查看Ip地址所用的Docker命令</th></tr></thead><tbody><tr><td>clusterMaster1</td><td>172.17.0.2</td><td>6379</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterMaster1</td></tr><tr><td>clusterMaster2</td><td>172.17.0.3</td><td>6380</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterMaster2</td></tr><tr><td>clusterMaster3</td><td>172.17.0.4</td><td>6381</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterMaster3</td></tr><tr><td>clusterSlave1</td><td>172.17.0.5</td><td>16379</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterSlave1</td></tr><tr><td>clusterSlave2</td><td>172.17.0.6</td><td>16380</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterSlave2</td></tr><tr><td>clusterSlave3</td><td>172.17.0.7</td><td>16381</td><td>docker inspect -f &lsquo;{{.NetworkSettings.IPAddress}}&rsquo; clusterSlave3</td></tr></tbody></table></div><p><strong>之后，进入clusterMaster1节点，使用&ndash;cluster create命令连接各个节点，这样所有的节点就在一个集群了。这里我也使用过cluster meet命令，但是使用这种方式后扩容时，添加的节点一直是从节点，具体原因未知</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入clusterMaster1节点，创建集群，注意此处还没有设置主从关系，这里设置的是--cluster-replicas 0</span>
</span></span><span class=line><span class=cl><span class=c1># 为的是想要创建6379(主)-16379(从)这样的对应关系，否则如果交给redis-cli自动处理的话，会出现端口端口随机配对的情况</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it clusterMaster1 bash
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster create --cluster-replicas <span class=m>0</span> 172.17.0.2:6379 172.17.0.3:6380 172.17.0.4:6381
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing <span class=nb>hash</span> slots allocation on <span class=m>3</span> nodes...
</span></span><span class=line><span class=cl>Master<span class=o>[</span>0<span class=o>]</span> -&gt; Slots <span class=m>0</span> - <span class=m>5460</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>1<span class=o>]</span> -&gt; Slots <span class=m>5461</span> - <span class=m>10922</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>2<span class=o>]</span> -&gt; Slots <span class=m>10923</span> - <span class=m>16383</span>
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>Can I <span class=nb>set</span> the above configuration? <span class=o>(</span><span class=nb>type</span> <span class=s1>&#39;yes&#39;</span> to accept<span class=o>)</span>: yes
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Nodes configuration updated
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Assign a different config epoch to each node
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> the cluster to join
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.2:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从上面可以看出redis-cli会根据你输入的yes，自动给三个主节点平均分配哈希槽</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 然后查看clusterMaster节点的cluster info。</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli 
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster info
</span></span><span class=line><span class=cl><span class=c1># 集群状态是fail</span>
</span></span><span class=line><span class=cl>cluster_state:fail
</span></span><span class=line><span class=cl><span class=c1># 分配的哈希槽为0</span>
</span></span><span class=line><span class=cl>cluster_slots_assigned:0
</span></span><span class=line><span class=cl>cluster_slots_ok:0
</span></span><span class=line><span class=cl>cluster_slots_pfail:0
</span></span><span class=line><span class=cl>cluster_slots_fail:0
</span></span><span class=line><span class=cl><span class=c1># 可以看到集群中有6个节点，但是集群状态是fail，说明集群还没有完成初始化。</span>
</span></span><span class=line><span class=cl><span class=c1># 原因是还没给每个节点分配哈希槽（Hash Slot）</span>
</span></span><span class=line><span class=cl>cluster_known_nodes:6
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># cluster nodes查看节点信息，可以看到三个主节点</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723297213811</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723297212809</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723297211000</span> <span class=m>1</span> connected 0-5460
</span></span></code></pre></td></tr></table></div></div><p><strong>4.为三个主节点分配从节点</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 为主节点172.17.0.2:6379配置从节点172.17.0.5:16379</span>
</span></span><span class=line><span class=cl><span class=c1># 172.17.0.5:16379为要添加的从节点IP和端口</span>
</span></span><span class=line><span class=cl><span class=c1># 172.17.0.2:6379为要添加的从节点所属集群的任意一个节点的IP和端口</span>
</span></span><span class=line><span class=cl><span class=c1># --cluster-master-id b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c为要添加的从节点对应的主节点ID</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster add-node 172.17.0.5:16379 172.17.0.2:6379 --cluster-slave --cluster-master-id b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Adding node 172.17.0.5:16379 to cluster 172.17.0.2:6379
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.2:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Send CLUSTER MEET to node 172.17.0.5:16379 to make it join the cluster.
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> the cluster to join
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Configure node as replica of 172.17.0.2:6379.
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> New node added correctly.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过输出信息，可以看到添加从节点成功，也可以通过cluster nodes验证</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723297831286</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723297830283</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723297828000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723297832289</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按照如上步骤，依次添加另外两个从节点172.17.0.6:16380和172.17.0.7:16381</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster add-node 172.17.0.6:16380 172.17.0.2:6379 --cluster-slave --cluster-master-id 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster add-node 172.17.0.7:16381 172.17.0.2:6379 --cluster-slave --cluster-master-id e2737cdc7073c3750ffb670bc618dc28cc939877 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行成功后，可以看到三主三从的集群搭建成功</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723298034325</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723298033323</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723298035332</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723298033000</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723298033000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723298035000</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 也可以这样查看 redis-cli --cluster check nodeHost:nodePort</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster check 172.17.0.2:6379
</span></span><span class=line><span class=cl>172.17.0.2:6379 <span class=o>(</span>b6d4a069...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>5461</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl>172.17.0.4:6381 <span class=o>(</span>e2737cdc...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>5461</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl>172.17.0.3:6380 <span class=o>(</span>8ba84e5b...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>5462</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> <span class=m>0</span> keys in <span class=m>3</span> masters.
</span></span><span class=line><span class=cl>0.00 keys per slot on average.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.2:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>S: 808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c
</span></span><span class=line><span class=cl>S: fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates e2737cdc7073c3750ffb670bc618dc28cc939877
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span></code></pre></td></tr></table></div></div><h4 id=在cluster中读写数据>在cluster中读写数据</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入clusterSlave1容器，然后执行redis-cli -p 16379 </span>
</span></span><span class=line><span class=cl>root@5d2ecf9131f7:/data# redis-cli -p <span class=m>16379</span>
</span></span><span class=line><span class=cl>127.0.0.1:16379&gt; <span class=nb>set</span> name farb
</span></span><span class=line><span class=cl><span class=c1># 写入数据时发现报错了，name应该放到哈希槽编号5798的主节点，该主节点的ip地址是172.17.0.3，端口是6380，但是一般来说用户希望透明地进行读写而不报错</span>
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> MOVED <span class=m>5798</span> 172.17.0.3:6380
</span></span><span class=line><span class=cl>127.0.0.1:16379&gt; <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=c1># 添加-c参数，表示开启集群模式，然后执行set name farb，发现写入成功</span>
</span></span><span class=line><span class=cl>root@5d2ecf9131f7:/data# redis-cli -p <span class=m>16379</span> -c
</span></span><span class=line><span class=cl>127.0.0.1:16379&gt; <span class=nb>set</span> name farb
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>5798<span class=o>]</span> located at 172.17.0.3:6380
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>172.17.0.3:6380&gt; get name
</span></span><span class=line><span class=cl><span class=s2>&#34;farb&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以上可以看到，redis-cli -c参数，在读或写时会自动地把数据定位到正确的服务器上，这种“自动定位”带来的“读写透明”效果正是开发项目所需要的。</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=模拟扩容和数据迁移动作>模拟扩容和数据迁移动作</h4><p>上面搭建的是3主3从的集群，键的读写会均摊到3个主节点上，cluster集群能很好地应对高并发的挑战。随着业务量的增大，对cluster集群的访问压力可能会增大，此时就需要对集群新增节点来承受更大的并发量。</p><p>现在模拟扩容和数据迁移动作，扩容集群，添加一个主节点clusterMaster4和从节点clusterSlave4，然后把数据迁移到新节点上。</p><h5 id=1新增主节点clustermaster4>1.新增主节点clusterMaster4</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># D:\ArchitectPracticer\Redis\RedisConfCluster目录下创建clusterMaster4.conf文件，内容如下</span>
</span></span><span class=line><span class=cl>port <span class=m>6382</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterMaster4.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterMaster4.conf
</span></span><span class=line><span class=cl>cluster-require-full-coverage no
</span></span><span class=line><span class=cl>appendonly yes
</span></span><span class=line><span class=cl>appendfsync everysec
</span></span><span class=line><span class=cl>cluster-slave-validity-factor <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建并运行容器</span>
</span></span><span class=line><span class=cl>docker run -itd -p 6382:6382 --name clusterMaster4 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw redis redis-server /redisConfig/clusterMaster4.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看容器IP</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s2>&#34;{{.NetworkSettings.IPAddress}}&#34;</span> clusterMaster4
</span></span><span class=line><span class=cl>172.17.0.8
</span></span></code></pre></td></tr></table></div></div><h5 id=2新增从节点clusterslave4>2.新增从节点clusterSlave4</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># D:\ArchitectPracticer\Redis\RedisConfCluster目录下创建clusterSlave4.conf文件，内容如下</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>port <span class=m>16382</span>
</span></span><span class=line><span class=cl>dir /redisConfig
</span></span><span class=line><span class=cl>logfile clusterSlave4.log
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-clusterSlave4.conf
</span></span><span class=line><span class=cl>cluster-require-full-coverage no
</span></span><span class=line><span class=cl>appendonly yes
</span></span><span class=line><span class=cl>appendfsync everysec
</span></span><span class=line><span class=cl>cluster-slave-validity-factor <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建并运行容器</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker run -itd -p 16382:16382 --name clusterSlave4 -v D:<span class=se>\A</span>rchitectPracticer<span class=se>\R</span>edis<span class=se>\R</span>edisConfCluster:/redisConfig:rw redis redis-server /redisConfig/clusterSlave4.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看容器IP</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker inspect -f <span class=s2>&#34;{{.NetworkSettings.IPAddress}}&#34;</span> clusterSlave4
</span></span><span class=line><span class=cl>172.17.0.9
</span></span></code></pre></td></tr></table></div></div><h5 id=3-使用cluster-add-node命令将新节点加入到集群中>3. 使用&ndash;cluster add-node命令将新节点加入到集群中</h5><p><strong>先看一下redis-cli &ndash;cluster中的帮助信息</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster <span class=nb>help</span>  
</span></span><span class=line><span class=cl>Cluster Manager Commands:
</span></span><span class=line><span class=cl>  create         host1:port1 ... hostN:portN
</span></span><span class=line><span class=cl>                 --cluster-replicas &lt;arg&gt;
</span></span><span class=line><span class=cl>  check          &lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space
</span></span><span class=line><span class=cl>                 --cluster-search-multiple-owners
</span></span><span class=line><span class=cl>  info           &lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space
</span></span><span class=line><span class=cl>  fix            &lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space
</span></span><span class=line><span class=cl>                 --cluster-search-multiple-owners
</span></span><span class=line><span class=cl>                 --cluster-fix-with-unreachable-masters
</span></span><span class=line><span class=cl>  reshard        &lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space
</span></span><span class=line><span class=cl>                 --cluster-from &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-to &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-slots &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-yes
</span></span><span class=line><span class=cl>                 --cluster-timeout &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-pipeline &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-replace
</span></span><span class=line><span class=cl>  rebalance      &lt;host:port&gt; or &lt;host&gt; &lt;port&gt; - separated by either colon or space
</span></span><span class=line><span class=cl>                 --cluster-weight &lt;<span class=nv>node1</span><span class=o>=</span>w1...nodeN<span class=o>=</span>wN&gt;
</span></span><span class=line><span class=cl>                 --cluster-use-empty-masters
</span></span><span class=line><span class=cl>                 --cluster-timeout &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-simulate
</span></span><span class=line><span class=cl>                 --cluster-pipeline &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-threshold &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-replace
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加新节点，如果是添加主节点，只需指定新节点的IP和端口，后面跟上集群中的一个节点的IP和端口即可。</span>
</span></span><span class=line><span class=cl><span class=c1># 如果是添加从节点，需要指定新节点的IP和端口，后面跟上集群中的一个节点的IP和端口，并且指定--cluster-slave和--cluster-master-id 两个参数            </span>
</span></span><span class=line><span class=cl>  add-node       new_host:new_port existing_host:existing_port
</span></span><span class=line><span class=cl>                 --cluster-slave
</span></span><span class=line><span class=cl>                 --cluster-master-id &lt;arg&gt;
</span></span><span class=line><span class=cl>  del-node       host:port node_id
</span></span><span class=line><span class=cl>  call           host:port <span class=nb>command</span> arg arg .. arg
</span></span><span class=line><span class=cl>                 --cluster-only-masters
</span></span><span class=line><span class=cl>                 --cluster-only-replicas
</span></span><span class=line><span class=cl>  set-timeout    host:port milliseconds
</span></span><span class=line><span class=cl>  import         host:port
</span></span><span class=line><span class=cl>                 --cluster-from &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-from-user &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-from-pass &lt;arg&gt;
</span></span><span class=line><span class=cl>                 --cluster-from-askpass
</span></span><span class=line><span class=cl>                 --cluster-copy
</span></span><span class=line><span class=cl>                 --cluster-replace
</span></span><span class=line><span class=cl>  backup         host:port backup_directory
</span></span><span class=line><span class=cl>  <span class=nb>help</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>For check, fix, reshard, del-node, set-timeout, info, rebalance, call, import, backup you can specify the host and port of any working node in the cluster.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Cluster Manager Options:
</span></span><span class=line><span class=cl>  --cluster-yes  Automatic yes to cluster commands prompts
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入集群中的一个节点容器，连接redis-cli,将扩容的主节点加入集群中</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster add-node 172.17.0.8:6382 172.17.0.2:6379
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Adding node 172.17.0.8:6382 to cluster 172.17.0.2:6379
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.2:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 83df1063a9726b8cbe75c3a838674a8292a8b258 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 7983ea1ae620a0de08edf3033f3e9b73c5b98f70 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: bd33358aa01625c99b7ea10832aa0340ded8816b 172.17.0.6:16380
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 7983ea1ae620a0de08edf3033f3e9b73c5b98f70
</span></span><span class=line><span class=cl>M: 59593191f51ae43efd1663b0d045aaca0dbd0a1e 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: f2485056c3a66327274235a350cb23257931c0ac 172.17.0.5:16379
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 83df1063a9726b8cbe75c3a838674a8292a8b258
</span></span><span class=line><span class=cl>S: ea1fec8d29809b8b68d2e38c300d9fc667fb7204 172.17.0.7:16381
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 59593191f51ae43efd1663b0d045aaca0dbd0a1e
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Getting functions from cluster
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Send FUNCTION LIST to 172.17.0.8:6382 to verify there is no functions in it
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Send FUNCTION RESTORE to 172.17.0.8:6382
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Send CLUSTER MEET to node 172.17.0.8:6382 to make it join the cluster.
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> New node added correctly.
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli 
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723300014894</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723300013891</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723300012887</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723300012000</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723300011000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723300014000</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 master - <span class=m>0</span> <span class=m>1723300015897</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看到新增的主节点已经加入到集群中了</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723300014894</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723300013891</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723300012887</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723300012000</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723300011000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723300014000</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 master - <span class=m>0</span> <span class=m>1723300015897</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 继续添加从节点</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster add-node 172.17.0.9:16382 172.17.0.2:6379 --cluster-slave --cluster-master-id 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster add-node 172.17.0.9:16382 172.17.0.2:6379 --cluster-slave --cluster-master-id 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Adding node 172.17.0.9:16382 to cluster 172.17.0.2:6379
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.2:6379<span class=o>)</span>
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>S: 808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c
</span></span><span class=line><span class=cl>S: fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates e2737cdc7073c3750ffb670bc618dc28cc939877
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Send CLUSTER MEET to node 172.17.0.9:16382 to make it join the cluster.
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> the cluster to join
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Configure node as replica of 172.17.0.8:6382.
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> New node added correctly.
</span></span><span class=line><span class=cl><span class=c1># 从节点添加到集群成功</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723300184000</span> <span class=m>3</span> connected 10923-16383
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723300185865</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382@26382 slave 8ae631285a8532aaeb324b404ab48352a25658ff <span class=m>0</span> <span class=m>1723300186869</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723300184863</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723300184000</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723300185000</span> <span class=m>1</span> connected 0-5460
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723300186000</span> <span class=m>2</span> connected 5461-10922
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 master - <span class=m>0</span> <span class=m>1723300183000</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看到新增的主从节点都已经加入到集群中了，但是扩容的主节点现在还并没有分配哈希槽,因而不能保存数据</span>
</span></span><span class=line><span class=cl><span class=c1># 下面进行重新分片,有两种方法，一种是使用交互式命令窗口按照提示操作，第二种是指定redis-cli reshard 命令的其他多个参数 --cluster-from --cluster-to --cluster-slots。这里使用第一种</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster reshard 172.17.0.8:6382
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.8:6382<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>S: fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates e2737cdc7073c3750ffb670bc618dc28cc939877
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl><span class=c1># 这里询问要移动多少哈希槽？为了平均分配，这里输入4096(16384/4=4096)后回车。</span>
</span></span><span class=line><span class=cl>How many slots <span class=k>do</span> you want to move <span class=o>(</span>from <span class=m>1</span> to 16384<span class=o>)</span>?4096
</span></span><span class=line><span class=cl><span class=c1># 这里询问接收的节点Id是什么？（也就是要给哪个节点分配哈希槽，可以通过cluster nodes命令查看）</span>
</span></span><span class=line><span class=cl>What is the receiving node ID?8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl><span class=c1># 这一步需要确认要从哪个节点移动哈希槽，输入all，要从所有节点移动哈希槽，目的是保证平均分配，当然你也可以自己指定节点的Id</span>
</span></span><span class=line><span class=cl>Please enter all the <span class=nb>source</span> node IDs.
</span></span><span class=line><span class=cl>  Type <span class=s1>&#39;all&#39;</span> to use all the nodes as <span class=nb>source</span> nodes <span class=k>for</span> the <span class=nb>hash</span> slots.
</span></span><span class=line><span class=cl>  Type <span class=s1>&#39;done&#39;</span> once you entered all the <span class=nb>source</span> nodes IDs.
</span></span><span class=line><span class=cl>Source node <span class=c1>#1: all</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    Moving slot <span class=m>351</span> from b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl>    Moving slot <span class=m>1361</span> from b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>    Moving slot <span class=m>1362</span> from b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>    Moving slot <span class=m>1363</span> from b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>    Moving slot <span class=m>1364</span> from b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl><span class=c1># 上面会显示从哪些节点移动哪些哈希槽，问你要不要继续提议的分片计划，输入yes回车 </span>
</span></span><span class=line><span class=cl>Do you want to proceed with the proposed reshard plan <span class=o>(</span>yes/no<span class=o>)</span>?yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 然后会输出大量日志，且耗时较长，如果redis中的数据量更大，耗时会更长</span>
</span></span><span class=line><span class=cl><span class=c1># 因此生产环境应该在专门的维护时间段进行扩容升级</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Moving slot <span class=m>1364</span> from 172.17.0.2:6379 to 172.17.0.8:6382: 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 然后使用redis-cli --cluster check 172.17.0.8:6382命令检查集群状态，发现4个主节点都分配了4096个哈希槽</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli --cluster check 172.17.0.8:6382
</span></span><span class=line><span class=cl>172.17.0.8:6382 <span class=o>(</span>8ae63128...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>4096</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl>172.17.0.4:6381 <span class=o>(</span>e2737cdc...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>4096</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl>172.17.0.3:6380 <span class=o>(</span>8ba84e5b...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>4096</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl>172.17.0.2:6379 <span class=o>(</span>b6d4a069...<span class=o>)</span> -&gt; <span class=m>0</span> keys <span class=p>|</span> <span class=m>4096</span> slots <span class=p>|</span> <span class=m>1</span> slaves.
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> <span class=m>0</span> keys in <span class=m>4</span> masters.
</span></span><span class=line><span class=cl>0.00 keys per slot on average.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing Cluster Check <span class=o>(</span>using node 172.17.0.8:6382<span class=o>)</span>
</span></span><span class=line><span class=cl>M: 8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-1364<span class=o>]</span>,<span class=o>[</span>5461-6826<span class=o>]</span>,<span class=o>[</span>10923-12287<span class=o>]</span> <span class=o>(</span><span class=m>4096</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>M: e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>12288-16383<span class=o>]</span> <span class=o>(</span><span class=m>4096</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c
</span></span><span class=line><span class=cl>M: 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>6827-10922<span class=o>]</span> <span class=o>(</span><span class=m>4096</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c
</span></span><span class=line><span class=cl>S: fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates e2737cdc7073c3750ffb670bc618dc28cc939877
</span></span><span class=line><span class=cl>M: b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>1365-5460<span class=o>]</span> <span class=o>(</span><span class=m>4096</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>   <span class=m>1</span> additional replica<span class=o>(</span>s<span class=o>)</span>
</span></span><span class=line><span class=cl>S: 25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382
</span></span><span class=line><span class=cl>   slots: <span class=o>(</span><span class=m>0</span> slots<span class=o>)</span> slave
</span></span><span class=line><span class=cl>   replicates 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All nodes agree about slots configuration.
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check <span class=k>for</span> open slots...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Check slots coverage...
</span></span><span class=line><span class=cl><span class=o>[</span>OK<span class=o>]</span> All <span class=m>16384</span> slots covered.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二种方法，172.17.0.8:6382指执行分配命令的节点， --cluster-slots N 指从每个from节点分配N个哈希槽</span>
</span></span><span class=line><span class=cl>redis-cli --cluster reshard 172.17.0.8:6382 --cluster-from e2737cdc7073c3750ffb670bc618dc28cc939877,8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c,b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c --cluster-to 8ae631285a8532aaeb324b404ab48352a25658ff --cluster-slots <span class=m>1024</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=故障自动恢复>故障自动恢复</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -c
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; get name
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>5798<span class=o>]</span> located at 172.17.0.8:6382
</span></span><span class=line><span class=cl><span class=o>(</span>nil<span class=o>)</span>
</span></span><span class=line><span class=cl>172.17.0.8:6382&gt; <span class=nb>set</span> name farb
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>172.17.0.8:6382&gt; get name
</span></span><span class=line><span class=cl><span class=s2>&#34;farb&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 这里模拟节点故障，关闭节点172.17.0.8:6382</span>
</span></span><span class=line><span class=cl>172.17.0.8:6382&gt; shutdown
</span></span><span class=line><span class=cl><span class=o>(</span>10.02s<span class=o>)</span>
</span></span><span class=line><span class=cl>not connected&gt; <span class=nb>exit</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; get name
</span></span><span class=line><span class=cl><span class=o>(</span>error<span class=o>)</span> CLUSTERDOWN The cluster is down
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; <span class=nb>exit</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster info
</span></span><span class=line><span class=cl>cluster_state:fail
</span></span><span class=line><span class=cl>cluster_slots_assigned:16384
</span></span><span class=line><span class=cl>cluster_slots_ok:12288
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 经过本人大量实验，需要设置clusterMaster4和clusterSlave4配置 cluster-slave-validity-factor 0 ，才可以将从节点提升为主节点</span>
</span></span><span class=line><span class=cl><span class=c1># 可以看到172.17.0.8:6382@16382 master,fail，之前的从节点提升为主节点172.17.0.9:16382@26382 master</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723389975343</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723389977352</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723389976348</span> <span class=m>3</span> connected 12288-16383
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723389974000</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 master,fail - <span class=m>1723389941225</span> <span class=m>1723389935203</span> <span class=m>7</span> connected
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723389975000</span> <span class=m>2</span> connected 6827-10922
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723389975000</span> <span class=m>1</span> connected 1365-5460
</span></span><span class=line><span class=cl>25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382@26382 master - <span class=m>0</span> <span class=m>1723389974340</span> <span class=m>9</span> connected 0-1364 5461-6826 10923-12287
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 此时再次get name，可以看到成功从新的主节点172.17.0.9:16382得到数据</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; get name
</span></span><span class=line><span class=cl>-&gt; Redirected to slot <span class=o>[</span>5798<span class=o>]</span> located at 172.17.0.9:16382
</span></span><span class=line><span class=cl><span class=s2>&#34;farb&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再次重启旧的主节点，发现旧的主节点已经变成新的主节点的从节点</span>
</span></span><span class=line><span class=cl>172.17.0.9:16382&gt; cluster nodes
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723478740183</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 master - <span class=m>0</span> <span class=m>1723478739000</span> <span class=m>1</span> connected 1365-5460
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723478742189</span> <span class=m>2</span> connected 6827-10922
</span></span><span class=line><span class=cl>25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382@26382 myself,master - <span class=m>0</span> <span class=m>1723478738000</span> <span class=m>13</span> connected 0-1364 5461-6826 10923-12287
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 slave 25a08774618e7964f9324e386ce21a2af61bbb9a <span class=m>0</span> <span class=m>1723478738119</span> <span class=m>13</span> connected
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723478741186</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723478741000</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723478738000</span> <span class=m>3</span> connected 12288-16383
</span></span></code></pre></td></tr></table></div></div><h4 id=从节点重新恢复为主节点>从节点重新恢复为主节点</h4><p><strong>原先的主节点宕机后，变成从节点，现在重新恢复为主节点</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入该从节点的容器，连接redis-cli,执行cluster failover</span>
</span></span><span class=line><span class=cl>root@83fd72d8d210:/data# redis-cli -p <span class=m>6382</span> -h 172.17.0.8
</span></span><span class=line><span class=cl>172.17.0.8:6382&gt; cluster failover takeover
</span></span><span class=line><span class=cl>OK
</span></span></code></pre></td></tr></table></div></div><h4 id=缩容删除节点>缩容：删除节点</h4><p><strong>只允许删除从节点和空的主节点，如果主节点分配了哈希槽，则需要先将哈希槽转移到其他节点，再进行删除</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 如果直接删除分配有哈希槽的主节点，则会报错，提示需要先重新分片</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster del-node 172.17.0.9:16382  25a08774618e7964f9324e386ce21a2af61bbb9a
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Removing node 25a08774618e7964f9324e386ce21a2af61bbb9a from cluster 172.17.0.9:16382
</span></span><span class=line><span class=cl><span class=o>[</span>ERR<span class=o>]</span> Node 172.17.0.9:16382 is not empty! Reshard data away and try again.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>redis-cli --cluster reshard 172.17.0.2:6379 --cluster-from 8ae631285a8532aaeb324b404ab48352a25658ff --cluster-to b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c --cluster-slots <span class=m>4096</span>
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>    Moving slot <span class=m>12286</span> from 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl>    Moving slot <span class=m>12287</span> from 8ae631285a8532aaeb324b404ab48352a25658ff
</span></span><span class=line><span class=cl>Do you want to proceed with the proposed reshard plan <span class=o>(</span>yes/no<span class=o>)</span>? yes
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>Moving slot <span class=m>12286</span> from 172.17.0.8:6382 to 172.17.0.2:6379: 
</span></span><span class=line><span class=cl>Moving slot <span class=m>12287</span> from 172.17.0.8:6382 to 172.17.0.2:6379: 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可以看到172.17.0.8:6382和172.17.0.9:16382都是从节点了</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723562047844</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>25a08774618e7964f9324e386ce21a2af61bbb9a 172.17.0.9:16382@26382 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723562045834</span> <span class=m>17</span> connected
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723562046000</span> <span class=m>17</span> connected
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723562049853</span> <span class=m>2</span> connected 6827-10922
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723562046000</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>8ae631285a8532aaeb324b404ab48352a25658ff 172.17.0.8:6382@16382 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723562048848</span> <span class=m>17</span> connected
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723562048000</span> <span class=m>3</span> connected 12288-16383
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723562049000</span> <span class=m>17</span> connected 0-6826 10923-12287
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行删除节点操作</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster del-node 172.17.0.9:16382  25a08774618e7964f9324e386ce21a2af61bbb9a
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Removing node 25a08774618e7964f9324e386ce21a2af61bbb9a from cluster 172.17.0.9:16382
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> --cluster del-node 172.17.0.2:6379 8ae631285a8532aaeb324b404ab48352a25658ff 
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Removing node 8ae631285a8532aaeb324b404ab48352a25658ff from cluster 172.17.0.2:6379
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Sending CLUSTER RESET SOFT to the deleted node.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 此时集群中又是三主三从了。</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>fc156444e5af0817468c95f8a86ec55310e06aed 172.17.0.7:16381@26381 slave e2737cdc7073c3750ffb670bc618dc28cc939877 <span class=m>0</span> <span class=m>1723562354046</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>30e652ae7137b28a304a6954acc7dd99a070be08 172.17.0.5:16379@26379 slave b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c <span class=m>0</span> <span class=m>1723562356053</span> <span class=m>17</span> connected
</span></span><span class=line><span class=cl>8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1723562353000</span> <span class=m>2</span> connected 6827-10922
</span></span><span class=line><span class=cl>808b97759fd358611f94edca21836c4d68d63467 172.17.0.6:16380@26380 slave 8ba84e5b7c76e8530529b41d8c6ee59f3d3edf0c <span class=m>0</span> <span class=m>1723562354000</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>e2737cdc7073c3750ffb670bc618dc28cc939877 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1723562355050</span> <span class=m>3</span> connected 12288-16383
</span></span><span class=line><span class=cl>b6d4a069fdd4acf4d46133e56bfa79cb6d03b77c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1723562354000</span> <span class=m>17</span> connected 0-6826 10923-12287
</span></span></code></pre></td></tr></table></div></div><h4 id=cluster集群中的常用配置>cluster集群中的常用配置</h4><ol><li>cluster-enabled yes：开启cluster集群模式</li><li>cluster-config-file：cluster集群节点配置文件，Redis服务器第一次以cluster节点身份启动时自动生成，保存了cluster集群里本节点和其他节点之间的关联方式</li><li>dir: 指定cluster-config-file文件和日志文件保存的路径</li><li>logfile: 指定当前节点的日志文件名</li><li>cluster-node-timeout：cluster集群节点之间的超时时间，单位为毫秒，如果超过该时间，则认为节点已经离线，会向对应的从节点进行故障转移操作。</li><li>cluster-require-full-coverage：默认为yes。表示cluster集群中有节点失效时该集群是否继续对外提供写服务，出于容错性考虑，建议设置为no,如果设置为yes,那么集群中有节点失效时，该集群只提供只读服务。</li><li>cluster-migration-barrier：用来设置主节点的最小从节点数量。假设该值为1，当某主节点的从节点数量小于1时，就会从其他从节点个数大于1的主节点那边调剂1个从节点过来，这样做的目的是避免出现不包含从节点的主节点，因为一旦出现这种情况，当主节点失效时，就无法再用从节点进行故障恢复的动作。</li><li>cluster-slave-validity-factor: 如果设置成０，则无论从节点与主节点失联多久，从节点都会尝试升级成主节点。如果设置成正数，则cluster-node-timeout乘以cluster-slave-validity-factor得到的时间，是从节点与主节点失联后，此从节点数据有效的最长时间，超过这个时间，从节点不会启动故障迁移。假设cluster-node-timeout=5，cluster-slave-validity-factor=10，则如果从节点跟主节点失联超过50秒，此从节点不能成为主节点。注意，如果此参数配置为非0，将可能出现由于某主节点失联却没有从节点能顶上的情况，从而导致集群不能正常工作，在这种情况下，只有等到原来的主节点重新回归到集群，集群才恢复运作。</li><li>repl-diskless-load : mastar 节点有两种方式传输 RDB，slave 节点也有两种方式加载 master 传输过来的 RDB 数据。
传统方式：接受到数据后，先持久化到磁盘，再从磁盘加载 RDB 文件恢复数据到内存中，这是传统方式。
diskless-load：从 Socket 中一边接受数据，一边解析，实现无盘化。
一共有三个取值可配置：
disabled：不使用 diskless-load 方式，即采用磁盘化的传统方式。
on-empty-db：安全模式下使用 diskless-load（也就 slave 节点数据库为空的时候使用 diskless-load）。
swapdb：使用 diskless-load 方式加载，slave 节点会缓存一份当前数据库的数据，再清空数据库，接着进行 Socket 读取实现加载。缓存一份数据的目的是防止读取 Socket 失败。</li></ol><h4 id=补充使用cluster-meet>补充：使用cluster meet</h4><p><strong>我也实践了下cluster meet命令，但是没有得到预期的结果，不知道是Redis版本（7.2.5）问题还是啥原因。出现的问题是：三主三从的集群可以搭建成功，但是在扩容时，新加入的节点始终是从节点，下面是我的原始命令</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 注意这里meet之后的ip是容器所在的IP地址，不是localhost</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> cluster meet 172.17.0.3 <span class=m>6380</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> cluster meet 172.17.0.4 <span class=m>6381</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> cluster meet 172.17.0.5 <span class=m>16379</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> cluster meet 172.17.0.6 <span class=m>16380</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -p <span class=m>6379</span> cluster meet 172.17.0.7 <span class=m>16381</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 一次只能添加一个哈希槽</span>
</span></span><span class=line><span class=cl>redis-cli -h hostIp -p port Cluster AddSlots N
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加哈希槽范围，依次可以添加多个哈希槽</span>
</span></span><span class=line><span class=cl>redis-cli -h hostIp -p port Cluster ADDSLOTSRANGE &lt;start slot&gt; &lt;end slot&gt; <span class=o>[</span>&lt;start slot&gt; &lt;end slot&gt; ...<span class=o>]</span>
</span></span><span class=line><span class=cl>    Assign slots which are between &lt;start-slot&gt; and &lt;end-slot&gt; to current node.
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 给节点hostIp:port分配哈希槽N，其中N是哈希槽的编号，从0到16383  </span>
</span></span><span class=line><span class=cl><span class=c1># 由于每次只能分配一个编号，所以这里写一个bash脚本，循环执行</span>
</span></span><span class=line><span class=cl><span class=sb>`</span>redis-cli -h hostIp -p port Cluster AddSlots N<span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># D:\ArchitectPracticer\Redis\RedisConfCluster目录下新建SetMaster1HashSlots.sh，内容如下：</span>
</span></span><span class=line><span class=cl><span class=c1># 分配哈希槽[0,5460]给clusterMaster1</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>0</span> 5460<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    redis-cli -h 172.17.0.2 -p <span class=m>6379</span> Cluster AddSlots <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以上脚本等价于</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -h 172.17.0.2 -p <span class=m>6379</span>                       
</span></span><span class=line><span class=cl>172.17.0.2:6379&gt; cluster addslotsrange <span class=m>0</span> <span class=m>5460</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># D:\ArchitectPracticer\Redis\RedisConfCluster目录下新建SetMaster2HashSlots.sh，内容如下：</span>
</span></span><span class=line><span class=cl><span class=c1># 分配哈希槽[5461,10922]给clusterMaster2</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>5461</span> 10922<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    redis-cli -h 172.17.0.3 -p <span class=m>6380</span> Cluster AddSlots <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=c1># 以上脚本等价于</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -h 172.17.0.3 -p <span class=m>6380</span> 
</span></span><span class=line><span class=cl>172.17.0.3:6380&gt; CLUSTER ADDSLOTSRANGE <span class=m>5461</span> <span class=m>10922</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># D:\ArchitectPracticer\Redis\RedisConfCluster目录下新建SetMaster3HashSlots.sh，内容如下：</span>
</span></span><span class=line><span class=cl><span class=c1># 分配哈希槽[10923,16383]给clusterMaster3</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>10923</span> 16383<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>    redis-cli -h 172.17.0.4 -p <span class=m>6381</span> Cluster AddSlots <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl><span class=c1># 以上脚本等价于</span>
</span></span><span class=line><span class=cl>root@fb368ad5ad39:/data# redis-cli -h 172.17.0.4 -p <span class=m>6381</span>
</span></span><span class=line><span class=cl>172.17.0.4:6381&gt; cluster addslotsrange <span class=m>10923</span> <span class=m>16383</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过exit退出redis-cli，进入容器，然后依次执行脚本，会看到一直打印ok</span>
</span></span><span class=line><span class=cl>/redisConfig/SetMaster1HashSlots.sh 
</span></span><span class=line><span class=cl>/redisConfig/SetMaster21HashSlots.sh 
</span></span><span class=line><span class=cl>/redisConfig/SetMaster3HashSlots.sh 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行完毕后，此时已经给clusterMaster1、clusterMaster2、clusterMaster3分别分配了哈希槽，进入clusterMaster1容器，查看cluster info如下：</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster info
</span></span><span class=line><span class=cl><span class=c1># 集群状态是ok，说明集群已经完成初始化</span>
</span></span><span class=line><span class=cl>cluster_state:ok
</span></span><span class=line><span class=cl><span class=c1># 分配的哈希槽的个数为16384</span>
</span></span><span class=line><span class=cl>cluster_slots_assigned:16384
</span></span><span class=line><span class=cl>cluster_slots_ok:16384
</span></span><span class=line><span class=cl>cluster_slots_pfail:0
</span></span><span class=line><span class=cl>cluster_slots_fail:0
</span></span><span class=line><span class=cl><span class=c1># 可以看到集群中有6个节点</span>
</span></span><span class=line><span class=cl>cluster_known_nodes:6
</span></span><span class=line><span class=cl><span class=c1># 集群中主节点个数为3</span>
</span></span><span class=line><span class=cl>cluster_size:3
</span></span></code></pre></td></tr></table></div></div><p><strong>关联主节点和从节点</strong><br>设置从节点的方式是用redis-cli命令进入redis服务器从节点，然后运行<code>cluster replicate masterNodeId</code>.
masterNodeId是master节点的节点id，可以通过<code>cluster nodes</code>命令查看。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># 进入clusterMaster1容器,连接到redis-cli，然后查看集群节点id,很明显，第一列就是节点Id</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; cluster nodes
</span></span><span class=line><span class=cl>94c321bf8580621f267e7a0b502f6c1bd120f203 172.17.0.5:16379@26379 master - <span class=m>0</span> <span class=m>1722779543000</span> <span class=m>3</span> connected
</span></span><span class=line><span class=cl>8b9e6e09898be857fcd33e4a2611c42268ce7b1c 172.17.0.2:6379@16379 myself,master - <span class=m>0</span> <span class=m>1722779542000</span> <span class=m>2</span> connected 0-5460
</span></span><span class=line><span class=cl>207623a24974859ede6b1a59a046cb10fdfb7d54 172.17.0.7:16381@26381 master - <span class=m>0</span> <span class=m>1722779544247</span> <span class=m>5</span> connected
</span></span><span class=line><span class=cl>8794e2d834a7591630dced8cbaa073c1216de978 172.17.0.6:16380@26380 master - <span class=m>0</span> <span class=m>1722779544000</span> <span class=m>4</span> connected
</span></span><span class=line><span class=cl>fbb526d37ce8ef0067387d7810677200b5ed5d89 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1722779544000</span> <span class=m>0</span> connected 10923-16383
</span></span><span class=line><span class=cl>8192cc1bb0de71879b1f7174676260d3d5510a7f 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1722779543244</span> <span class=m>1</span> connected 5461-10922
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置clusterMaster1为clusterSlave1的主节点</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it clusterSlave1 bash
</span></span><span class=line><span class=cl>root@5d2ecf9131f7:/data# redis-cli -p <span class=m>16379</span>
</span></span><span class=line><span class=cl>127.0.0.1:16379&gt; cluster replicate 8b9e6e09898be857fcd33e4a2611c42268ce7b1c
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置clusterMaster2为clusterSlave2的主节点</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it clusterSlave2 bash
</span></span><span class=line><span class=cl>root@44e2e24b798a:/data# redis-cli -p <span class=m>16380</span>
</span></span><span class=line><span class=cl>127.0.0.1:16380&gt; cluster replicate 8192cc1bb0de71879b1f7174676260d3d5510a7f
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置clusterMaster3为clusterSlave3的主节点</span>
</span></span><span class=line><span class=cl>PS D:<span class=se>\c</span>ode<span class=se>\b</span>logs<span class=se>\f</span>arb.github.io&gt; docker <span class=nb>exec</span> -it clusterSlave3 bash
</span></span><span class=line><span class=cl>root@ef29a379b557:/data# redis-cli -p <span class=m>16381</span>
</span></span><span class=line><span class=cl>127.0.0.1:16381&gt; cluster replicate fbb526d37ce8ef0067387d7810677200b5ed5d89
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 至此，cluster集群三主三从节点已经搭建完成。可以进入任意一台服务器进行验证。</span>
</span></span><span class=line><span class=cl>127.0.0.1:16381&gt; cluster nodes
</span></span><span class=line><span class=cl>8794e2d834a7591630dced8cbaa073c1216de978 172.17.0.6:16380@26380 slave 8192cc1bb0de71879b1f7174676260d3d5510a7f <span class=m>0</span> <span class=m>1722780289575</span> <span class=m>1</span> connected
</span></span><span class=line><span class=cl>fbb526d37ce8ef0067387d7810677200b5ed5d89 172.17.0.4:6381@16381 master - <span class=m>0</span> <span class=m>1722780291000</span> <span class=m>0</span> connected 10923-16383
</span></span><span class=line><span class=cl>207623a24974859ede6b1a59a046cb10fdfb7d54 172.17.0.7:16381@26381 myself,slave fbb526d37ce8ef0067387d7810677200b5ed5d89 <span class=m>0</span> <span class=m>1722780289000</span> <span class=m>0</span> connected
</span></span><span class=line><span class=cl>8192cc1bb0de71879b1f7174676260d3d5510a7f 172.17.0.3:6380@16380 master - <span class=m>0</span> <span class=m>1722780290586</span> <span class=m>1</span> connected 5461-10922
</span></span><span class=line><span class=cl>94c321bf8580621f267e7a0b502f6c1bd120f203 172.17.0.5:16379@26379 slave 8b9e6e09898be857fcd33e4a2611c42268ce7b1c <span class=m>0</span> <span class=m>1722780291589</span> <span class=m>2</span> connected
</span></span><span class=line><span class=cl>8b9e6e09898be857fcd33e4a2611c42268ce7b1c 172.17.0.2:6379@16379 master - <span class=m>0</span> <span class=m>1722780290000</span> <span class=m>2</span> connected 0-5460
</span></span></code></pre></td></tr></table></div></div><p><strong>使用cluster meet命令创建集群之后，不论是使用cluster meet还是redis-cli &ndash;cluster add-node添加的节点都是从节点。具体原因待以后继续调查。</strong></p></section><footer class=article-footer><section class=article-tags><a href=/tags/redis/>Redis</a>
<a href=/tags/docker/>Docker</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section>页面浏览量<span id=busuanzi_value_page_pv>Loading</span></section><section><strong>如果觉得我的博客能帮助到你，欢迎点击右侧的赞助进行投喂。如有技术咨询，也可以加本人好友。</strong></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/redis_in_action_13_redis_springcloud/><div class=article-details><h2 class=article-title>基于Docker的Redis实战-Redis与SpringCloud微服务整合</h2></div></a></article><article><a href=/p/redis_in_action_12_redis_springboot/><div class=article-details><h2 class=article-title>基于Docker的Redis实战-Redis与SpringBoot整合</h2></div></a></article><article><a href=/p/redis_in_action_11_lua/><div class=article-details><h2 class=article-title>基于Docker的Redis实战-Redis整合Lua脚本</h2></div></a></article><article><a href=/p/redis_in_action_10_mysql_mycat/><div class=article-details><h2 class=article-title>基于Docker的Redis实战-Redis整合Mysql集群和MyCat分库分表组件</h2></div></a></article><article><a href=/p/redis_in_action_09_redis_practical_cases/><div class=article-details><h2 class=article-title>基于Docker的Redis实战-Redis消息队列、分布式锁、限流、压力测试综合实践案例</h2></div></a></article></div></div></aside><script src=//unpkg.com/@waline/client@v2/dist/waline.js></script><link href=//unpkg.com/@waline/client@v2/dist/waline.css rel=stylesheet><div id=waline class=waline-container></div><style>.waline-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding);--waline-font-size:var(--article-font-size)}.waline-container .wl-count{color:var(--card-text-color-main)}</style><script>Waline.init({avatar:"",dark:'html[data-scheme="dark"]',el:"#waline",emoji:["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],lang:"zh-cn",locale:{admin:"Admin",placeholder:null},placeholder:"",requiredMeta:["name","email"],serverURL:"https://blog.comment.farb.top",visitor:""})</script><footer class=site-footer><section class=copyright>&copy;
2024 -
2025 Farb's Blog</section><section class=powerby>总访客数：<span id=busuanzi_value_site_uv style=margin-right:10px>Loading</span> 总访问量：<span id=busuanzi_value_site_pv style=margin-right:10px>Loading</span>
<a href=https://eu.umami.is/share/y6kXo4CE3oYHXQ37/farb.github.io style=color:blue target=_blank>实时统计</a><br><span id=span_show_age style=margin-right:30px><br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script src=https://cdn.jsdelivr.net/npm/tctip@1.0.4/dist/tctip-1.0.3.min.js></script><script>new tctip({top:"20%",button:{id:8,type:"zanzhu"},list:[{type:"alipay",qrImg:"https://github.com/user-attachments/assets/3ac3da80-aa15-4ab7-bee7-7292a08fcda1"},{type:"wechat",qrImg:"https://github.com/user-attachments/assets/efc07320-351b-45f3-9a89-a938050da4ef"},{type:"weixin",name:"加好友",icon:"https://s3.bmp.ovh/imgs/2024/04/24/6feafb7f63995dfe.png",qrImg:"https://s3.bmp.ovh/imgs/2024/04/24/e2ae8bd59da6e3a8.jpg",desc:"微信:beingBetterSelf"}]}).init()</script><script defer src=https://cn.vercount.one/js></script><script defer src=https://analytics.eu.umami.is/script.js data-website-id=0a12e949-0500-4ff1-872c-b8969b376add></script><script defer language=javascript>var uptime_1="本站已经开心运行 ",uptime_2=" 天 ",uptime_3=" 小时 ",uptime_4=" 分 ",uptime_5=" 秒";function show_date_time(){window.setTimeout(show_date_time,1e3),BirthDay=new Date("4/08/2024 22:54:23"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=24*60*60*1e3,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=(e_daysold-daysold)*24,hrsold=Math.floor(e_hrsold),e_minsold=(e_hrsold-hrsold)*60,minsold=Math.floor((e_hrsold-hrsold)*60),seconds=Math.floor((e_minsold-minsold)*60),document.getElementById("span_show_age").innerHTML=uptime_1+daysold+uptime_2+hrsold+uptime_3+minsold+uptime_4+seconds+uptime_5}show_date_time()</script></body></html>